<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <script>
        function generatePromptPayPayload(phoneNumber, amount) {
            const target = phoneNumber.replace(/^0/, '66');
            const f01 = '00' + target; 
            const tag29Value = '0016A000000677010111' + '01' + String(f01.length).padStart(2,'0') + f01;
            const tag29 = '29' + String(tag29Value.length).padStart(2,'0') + tag29Value;
            const tag53 = '5303764';
            const amtStr = amount.toFixed(2);
            const tag54 = '54' + String(amtStr.length).padStart(2,'0') + amtStr;
            const tag58 = '5802TH';
            const data = '000201' + '010212' + tag29 + tag53 + tag54 + tag58 + '6304';
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF;
                x ^= x >> 4;
                crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
            }
            return data + crc.toString(16).toUpperCase().padStart(4, '0');
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .map-container { position: relative; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: fadeIn 0.3s ease-out forwards; }
        .map-pin-responsive { transition: transform 0.2s; }
        @media (max-width: 640px) {
            .map-pin-responsive { transform: translate(-50%, -50%) scale(0.8) !important; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        
        /* Loading Animation */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMqbjDfim6sg2xOUL2FFXmEByd9SYhlXWjyZizH-rx7DoKR5uVIQlLrQIUh8UFidna/exec"; 
        const LIFF_ID = "2009071905-gqPfk8Cy"; 
        const PROMPTPAY_PHONE = "0615924262";
        const PROMPTPAY_NAME = "‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á";

        const compressImage = async (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 800;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const base64ToBlob = (base64) => {
            const parts = base64.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) { uInt8Array[i] = raw.charCodeAt(i); }
            return new Blob([uInt8Array], { type: contentType });
        };

        const DEFAULT_CONFIG = {
            headerTitle: '‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ - Khanamlungdam',
            headerDesc: 'üè° ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡∏≥‡∏õ‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ï‡∏≠‡∏ô‡∏õ‡∏π‡πà‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏à‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå ‡πÅ‡∏°‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ß‡∏ô‡∏ú‡∏™‡∏° ‡∏ï‡∏≤‡∏°‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ‡∏õ‡πà‡∏≤ 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏á‡∏ö ‡∏°‡∏µ‡∏•‡∏≤‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏≠‡∏á‡πÑ‡∏ü ‡∏°‡∏µ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π ‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏°‡∏µ‡πÑ‡∏ß‡πÑ‡∏ü ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏£‡∏±‡∏ß‡πÑ‡∏ó‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏∑‡∏ô ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö',
            bannerUrl: 'https://img5.pic.in.th/file/secure-sv1/LINE_ALBUM__240916_14dd72f9bd7de4facf.jpg',
            logoUrl: 'https://lh3.googleusercontent.com/pw/AP1GczPi_rYAbsNGi4X96mW5koYl0JJ3BN9ipRf6UgsXAOQgkyhrs2ChGcZlbsuQ3OLJOYnYhSTYJhWUuu2hwWtPqlt4MUfdUDSS3s4RdRLeD36gPLiK-8OhYLXWmqxVLh2eOtkLIx7pQxrQA6ZnqBYHOftH=w913-h913-s-no-gm?authuser=0',
            roomImages: {},
            foodMenu: [],
            roomDescriptions: {}
        };

        const DEFAULT_POSITIONS = {
            'R1': {x: 20, y: 30}, 'R2': {x: 40, y: 50}, 'R3': {x: 60, y: 50},
            'T1': {x: 25, y: 70}, 'T2': {x: 35, y: 75}, 'K1': {x: 70, y: 70},
            'K2': {x: 80, y: 70}, 'Z8': {x: 50, y: 20}
        };
        
        const App = () => {
            const [isDark, setIsDark] = React.useState(true);
            const [step, setStep] = React.useState(1);
            
            const [mode, setMode] = React.useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('mode') === 'manage' ? 'manage' : 'booking';
            }); 

            const [dates, setDates] = React.useState({ checkIn: '', checkOut: '' });
            const [availability, setAvailability] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [cart, setCart] = React.useState([]);
            const [customer, setCustomer] = React.useState({ name: '', phone: '', userId: '', lineDisplayName: '' });
            const [pinPos, setPinPos] = React.useState(DEFAULT_POSITIONS);
            
            const [roomConfig, setRoomConfig] = React.useState({});
            const [systemSettings, setSystemSettings] = React.useState({ closed: [], special: [] });
            const [siteConfig, setSiteConfig] = React.useState(() => {
                const cached = localStorage.getItem('lungdam_site_config');
                return cached ? { ...DEFAULT_CONFIG, ...JSON.parse(cached) } : DEFAULT_CONFIG;
            });

            const [discount, setDiscount] = React.useState({ code: '', val: 0, type: '', message: '', status: '' });
            const [checkingDiscount, setCheckingDiscount] = React.useState(false); 

            const [slipImg, setSlipImg] = React.useState(null);
            const [bookingResult, setBookingResult] = React.useState(null);
            const [agreed, setAgreed] = React.useState(false);
            const [qrUrl, setQrUrl] = React.useState(null);
            
            const [selectedRoomId, setSelectedRoomId] = React.useState(null);
            const [guestCount, setGuestCount] = React.useState(1);
            const [selectedFood, setSelectedFood] = React.useState(null);
            const [foodCount, setFoodCount] = React.useState(1);

            const [closedModal, setClosedModal] = React.useState(null); 
            const [searchError, setSearchError] = React.useState(null);
            const [currentImgIdx, setCurrentImgIdx] = React.useState(0);
            const [showRoomRequiredModal, setShowRoomRequiredModal] = React.useState(false);

            const [manageForm, setManageForm] = React.useState({ bookingId: '', phone: '' });
            const [manageData, setManageData] = React.useState(null);
            const [rescheduleDates, setRescheduleDates] = React.useState({ checkIn: '', checkOut: '' });
            const [manageTab, setManageTab] = React.useState('info'); 
            const [addOnCart, setAddOnCart] = React.useState([]); 
            const [addOnSlip, setAddOnSlip] = React.useState(null);
            const [addOnQr, setAddOnQr] = React.useState(null);

            const [modalAlert, setModalAlert] = React.useState({ show: false, type: 'info', title: '', text: '' }); 
            const [modalConfirm, setModalConfirm] = React.useState({ show: false, title: '', text: '', onConfirm: null });

            const getTommorow = () => {
                const d = new Date();
                d.setDate(d.getDate() + 1);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatThaiDate = (dateStr) => {
                if(!dateStr) return "-";
                const date = new Date(dateStr);
                const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
            };

            const getClosedDateOverlap = (inDate, outDate) => {
                let current = new Date(inDate);
                const end = new Date(outDate);
                while(current < end) {
                    const dStr = current.toISOString().split('T')[0];
                    const closed = systemSettings.closed.find(c => c.date === dStr);
                    if (closed) return closed;
                    current.setDate(current.getDate() + 1);
                }
                return null;
            };

            const checkDateOverlapHighSeason = (inDate, outDate) => {
                let current = new Date(inDate);
                const end = new Date(outDate);
                while(current < end) {
                    const dStr = current.toISOString().split('T')[0];
                    if (systemSettings.special.some(s => s.date === dStr)) return true;
                    current.setDate(current.getDate() + 1);
                }
                return false;
            };

            const calculateNights = () => {
                if(!dates.checkIn || !dates.checkOut) return 0;
                return (new Date(dates.checkOut) - new Date(dates.checkIn)) / (1000 * 3600 * 24);
            }

            const getPricing = () => {
                const nights = calculateNights();
                let roomTotal = 0; let foodTotal = 0; let z8Total = 0;
                cart.forEach(item => {
                    if (item.type === 'food') foodTotal += item.price * item.qty;
                    else if (item.id === 'Z8') z8Total += item.pricePerNight * nights * item.guests; 
                    else roomTotal += item.pricePerNight * nights;
                });

                let discountAmt = 0;
                if (discount.type === 'FIXED') discountAmt = discount.val;
                if (discount.type === 'PERCENT') discountAmt = (roomTotal * discount.val) / 100;
                if (discountAmt > roomTotal) discountAmt = roomTotal; 

                const totalBefore = roomTotal + z8Total + foodTotal;
                const netTotal = totalBefore - discountAmt;

                let deposit = 0;
                const isHigh = checkDateOverlapHighSeason(dates.checkIn, dates.checkOut);
                if (isHigh) deposit = netTotal;
                else {
                    const roomDeposit = (roomTotal - discountAmt) * 0.5;
                    deposit = roomDeposit + z8Total + foodTotal;
                }
                return { total: totalBefore, discount: discountAmt, netTotal: netTotal, deposit: Math.ceil(deposit), isHighSeason: isHigh };
            };

            const pricing = React.useMemo(() => getPricing(), [cart, dates, discount, systemSettings]);
            const canSubmit = customer.name && customer.phone && slipImg && agreed;

            React.useEffect(() => {
                if (LIFF_ID) {
                    liff.init({ liffId: LIFF_ID }).then(() => {
                        if (liff.isLoggedIn()) {
                            liff.getProfile().then(profile => {
                                setCustomer(prev => ({...prev, userId: profile.userId, lineDisplayName: profile.displayName}));
                            });
                        }
                    }).catch(err => console.error('LIFF Error', err));
                }
                
                fetch(`${GOOGLE_SCRIPT_URL}?action=getMapConfig`)
                    .then(r => r.json()).then(res => { if (res.status === 'success') setPinPos(res.data); })
                    .catch(e => console.error(e));

                fetch(`${GOOGLE_SCRIPT_URL}?action=getSettings`)
                    .then(r => r.json()).then(res => { 
                        if (res.status === 'success') {
                            setSystemSettings({ closed: res.closed, special: res.special });
                        }
                    })
                    .catch(e => console.error(e));

                fetch(`${GOOGLE_SCRIPT_URL}?action=getSiteSettings`)
                    .then(r => r.json()).then(res => { 
                        if (res.status === 'success') {
                            setSiteConfig(prev => {
                                const newConfig = {...prev, ...res.data};
                                localStorage.setItem('lungdam_site_config', JSON.stringify(newConfig));
                                return newConfig;
                            });
                        }
                    })
                    .catch(e => console.error(e));

                fetch(`${GOOGLE_SCRIPT_URL}?action=getRoomConfig`)
                    .then(r => r.json()).then(res => {
                        if (res.status === 'success') {
                            setRoomConfig(res.data);
                        }
                    })
                    .catch(e => console.error(e));

            }, []);

            React.useEffect(() => {
                if (step === 3 && pricing.deposit > 0) {
                    const payload = generatePromptPayPayload(PROMPTPAY_PHONE, pricing.deposit);
                    const qr = new QRious({ value: payload, size: 300 }); 
                    setQrUrl(qr.toDataURL());
                }
            }, [step, pricing.deposit]);

            React.useEffect(() => {
                if (mode === 'manage' && manageTab === 'food') {
                    const total = addOnCart.reduce((sum,c)=>sum+(c.price*c.qty),0);
                    if (total > 0) {
                         const payload = generatePromptPayPayload(PROMPTPAY_PHONE, total);
                         const qr = new QRious({ value: payload, size: 200 });
                         setAddOnQr(qr.toDataURL());
                    } else {
                         setAddOnQr(null);
                    }
                }
            }, [addOnCart, mode, manageTab]);

            const handleSearch = () => {
                if (!dates.checkIn || !dates.checkOut) { setSearchError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
                if (dates.checkIn >= dates.checkOut) { setSearchError('‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
                const closedFound = getClosedDateOverlap(dates.checkIn, dates.checkOut);
                if (closedFound) { setClosedModal(closedFound); return; }
                setLoading(true);
                fetch(`${GOOGLE_SCRIPT_URL}?action=getAvailability&checkIn=${dates.checkIn}&checkOut=${dates.checkOut}`)
                    .then(r => r.json()).then(data => { setAvailability(data); setStep(2); setLoading(false); })
                    .catch(e => { alert('Error: ' + e); setLoading(false); });
            };

            const openRoomModal = (roomId) => {
                const room = roomConfig[roomId];
                if (!room) return;
                // [FIXED] Force integer for initial guest count
                if(roomId === 'Z8') setGuestCount(1);
                else setGuestCount(parseInt(room.min) || 1);
                setCurrentImgIdx(0); 
                setSelectedRoomId(roomId);
            };

            const openFoodModal = (food) => { setSelectedFood(food); setFoodCount(1); };

            const confirmFoodSelection = () => {
                const targetCart = mode === 'manage' ? addOnCart : cart;
                const setTargetCart = mode === 'manage' ? setAddOnCart : setCart;

                const exist = targetCart.find(c => c.id === selectedFood.id);
                if (exist) {
                    setTargetCart(targetCart.map(c => c.id === selectedFood.id ? { ...c, qty: c.qty + foodCount } : c));
                } else {
                    setTargetCart([...targetCart, { ...selectedFood, type: 'food', qty: foodCount }]);
                }
                setSelectedFood(null);
            };

            const nextImage = () => { if(!selectedRoomId) return; const images = siteConfig.roomImages[selectedRoomId] || []; setCurrentImgIdx((prev) => (prev + 1) % images.length); };
            const prevImage = () => { if(!selectedRoomId) return; const images = siteConfig.roomImages[selectedRoomId] || []; setCurrentImgIdx((prev) => (prev - 1 + images.length) % images.length); };

            // [FIXED] confirmRoomSelection with Safe Integer Parsing & Error Handling
            const confirmRoomSelection = () => {
                try {
                    const roomId = selectedRoomId;
                    const guests = parseInt(guestCount); // Ensure integer
                    const roomInfo = roomConfig[roomId];
                    
                    if (!roomInfo) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å"); return; }
                    
                    // Validate availability for Z8
                    if (roomId === 'Z8') {
                        const currentZ8 = cart.filter(c => c.id === 'Z8').reduce((sum, c) => sum + c.guests, 0);
                        if (currentZ8 + guests > availability.zone8Available) { 
                            alert(`‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏µ‡∏Å ${availability.zone8Available - currentZ8} ‡∏ó‡πà‡∏≤‡∏ô`); 
                            return; 
                        }
                    }
                    
                    // Pricing Logic with Safety Checks & Integer Parsing
                    let price = 0;
                    if (roomId === 'Z8') { 
                        price = parseInt(roomInfo.pricing.priceHead || 0); 
                    } else { 
                        if (!roomInfo.pricing || !roomInfo.pricing.tiers) {
                             console.warn("Pricing tiers missing for room " + roomId);
                             price = 0; 
                        } else {
                            const tier = roomInfo.pricing.tiers.find(t => guests <= t.max); 
                            const selectedTier = tier || roomInfo.pricing.tiers[roomInfo.pricing.tiers.length - 1]; 
                            price = parseInt(selectedTier.price || 0); 
                        }
                    }
                    
                    setCart([...cart, { id: roomId, name: roomInfo.name, type: roomInfo.type, guests, pricePerNight: price, nights: calculateNights() }]);
                    setSelectedRoomId(null);
                } catch (e) {
                    console.error(e);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á: " + e.message);
                }
            };

            const checkDiscountCode = () => { 
                if(!discount.code) return; 
                setCheckingDiscount(true); 
                fetch(`${GOOGLE_SCRIPT_URL}?action=checkDiscount&code=${discount.code}`)
                    .then(r=>r.json())
                    .then(d => { 
                        setCheckingDiscount(false); 
                        if(d.status === 'success') { 
                            setDiscount({...discount, val: parseInt(d.value), type: d.type, message: `‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏î ${d.value} ${d.type==='PERCENT'?'%':'‡∏ö‡∏≤‡∏ó'}`, status: 'success'}); 
                        } else { 
                            setDiscount({...discount, val: 0, type: '', message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ', status: 'error'}); 
                        } 
                    })
                    .catch(() => {
                        setCheckingDiscount(false);
                        setDiscount({...discount, val: 0, type: '', message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', status: 'error'});
                    }); 
            };

            const handleSubmit = () => {
                if (!canSubmit) return;
                setLoading(true);
                const payload = {
                    action: 'saveBooking',
                    customer, checkIn: dates.checkIn, checkOut: dates.checkOut,
                    totalGuests: cart.filter(c => c.type !== 'food').reduce((s, c) => s + c.guests, 0),
                    cart, pricing, discountCode: discount.code, slipImage: slipImg
                };
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json()).then(res => { if (res.status === 'success') { setBookingResult(res.bookingId); setStep(5); } else { alert('Error: ' + res.message); } setLoading(false); }).catch(e => { alert('Failed: ' + e); setLoading(false); });
            };

            const handleDownloadQr = () => {
                if(!qrUrl) return;
                try { const blob = base64ToBlob(qrUrl); const url = window.URL.createObjectURL(blob); const link = document.createElement('a'); link.style.display = 'none'; link.href = url; link.download = 'payment-qr.png'; document.body.appendChild(link); link.click(); setTimeout(() => { document.body.removeChild(link); window.URL.revokeObjectURL(url); }, 100); } catch (e) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); }
            };

            const handleFindBooking = () => {
                if(!manageForm.bookingId || !manageForm.phone) {
                    setModalAlert({ show: true, type: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' });
                    return;
                }
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'findBooking', bookingId: manageForm.bookingId, phone: manageForm.phone })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if(res.status === 'success') {
                        setManageData(res.booking);
                        setManageTab('info');
                    } else {
                        setModalAlert({ show: true, type: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: res.message });
                    }
                })
                .catch(e => { 
                    setLoading(false); 
                    setModalAlert({ show: true, type: 'error', title: 'Error', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' }); 
                });
            };

            const handleCustomerReschedule = () => {
                if(!rescheduleDates.checkIn || !rescheduleDates.checkOut) {
                    setModalAlert({ show: true, type: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
                    return;
                }

                if(rescheduleDates.checkIn < getTommorow()) {
                     setModalAlert({ show: true, type: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö' });
                     return;
                }

                if(rescheduleDates.checkIn >= rescheduleDates.checkOut) {
                    setModalAlert({ show: true, type: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô' });
                    return;
                }
                
                setModalConfirm({
                    show: true,
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å',
                    text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô\n${formatThaiDate(rescheduleDates.checkIn)} - ${formatThaiDate(rescheduleDates.checkOut)}\n‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    onConfirm: () => {
                        setModalConfirm({ ...modalConfirm, show: false });
                        executeReschedule();
                    }
                });
            };

            const executeReschedule = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'customerReschedule',
                        bookingId: manageData.id,
                        phone: manageForm.phone,
                        newCheckIn: rescheduleDates.checkIn,
                        newCheckOut: rescheduleDates.checkOut
                    })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if(res.status === 'success') {
                        setModalAlert({ show: true, type: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö' });
                        setManageData(null);
                        setManageForm({bookingId: '', phone: ''});
                        setMode('booking');
                    } else {
                        setModalAlert({ show: true, type: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', text: res.message });
                    }
                })
                .catch(e => { 
                    setLoading(false); 
                    setModalAlert({ show: true, type: 'error', title: 'Error', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e });
                });
            };

            const handleCustomerAddFood = () => {
                if(addOnCart.length === 0) {
                    setModalAlert({ show: true, type: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' });
                    return;
                }
                if(!addOnSlip) {
                    setModalAlert({ show: true, type: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' });
                    return;
                }
                
                setModalConfirm({
                    show: true,
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                    text: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n${addOnCart.map(i => '- ' + i.name + ' x' + i.qty).join('\n')}\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`,
                    onConfirm: () => {
                        setModalConfirm({ ...modalConfirm, show: false });
                        executeAddFood();
                    }
                });
            };

            const executeAddFood = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'customerAddFood',
                        bookingId: manageData.id,
                        phone: manageForm.phone,
                        newFoodItems: addOnCart,
                        slipImage: addOnSlip 
                    })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if(res.status === 'success') {
                        setModalAlert({ show: true, type: 'success', title: '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö' });
                        setManageData(null);
                        setManageForm({bookingId: '', phone: ''});
                        setAddOnCart([]);
                        setAddOnSlip(null);
                        setMode('booking');
                    } else {
                        setModalAlert({ show: true, type: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', text: res.message });
                    }
                })
                .catch(e => { 
                    setLoading(false); 
                    setModalAlert({ show: true, type: 'error', title: 'Error', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e });
                });
            };

            return (
                <div className={isDark ? "dark" : ""}>
                    <div className="min-h-screen bg-[#f3f4f6] dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">
                        <button 
                            onClick={() => setIsDark(!isDark)} 
                            className="fixed top-4 right-4 z-50 bg-white dark:bg-gray-700 p-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 w-10 h-10 flex items-center justify-center transition-transform hover:scale-110"
                        >
                            {isDark ? '‚òÄÔ∏è' : 'üåô'}
                        </button>

                        <button 
                            onClick={() => {
                                setMode(mode === 'booking' ? 'manage' : 'booking');
                                setStep(1);
                                setManageData(null);
                                setManageTab('info');
                                setAddOnCart([]);
                                setAddOnSlip(null);
                            }}
                            className="fixed top-16 right-4 z-50 bg-white dark:bg-gray-700 p-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 w-10 h-10 flex items-center justify-center transition-transform hover:scale-110 text-gray-800 dark:text-white"
                        >
                             {mode === 'booking' ? <i className="fas fa-search"></i> : <i className="fas fa-home"></i>}
                        </button>

                        {/* --- LOADING OVERLAY --- */}
                        {loading && (
                            <div className="fixed inset-0 z-[999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity">
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 flex flex-col items-center animate-pop max-w-sm w-full mx-4">
                                    <div className="relative w-20 h-20 mb-6">
                                         <div className="absolute top-0 left-0 w-full h-full border-4 border-gray-100 dark:border-gray-700 rounded-full"></div>
                                         <div className="absolute top-0 left-0 w-full h-full border-4 border-green-500 rounded-full border-t-transparent animate-spin"></div>
                                         <div className="absolute inset-0 flex items-center justify-center">
                                            <i className="fas fa-campground text-green-500 text-xl animate-bounce-slow"></i>
                                         </div>
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</h3>
                                    <p className="text-gray-500 dark:text-gray-400 text-sm text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
                                </div>
                            </div>
                        )}

                        {mode === 'manage' && (
                            <div className="max-w-md mx-auto p-4 pt-16">
                                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4 text-center text-blue-600 dark:text-blue-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á / ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                                    
                                    {!manageData ? (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Booking ID)</label>
                                                <input className="w-full border p-2 rounded dark:bg-gray-700" placeholder="‡πÄ‡∏ä‡πà‡∏ô BK-123456" value={manageForm.bookingId} onChange={e => setManageForm({...manageForm, bookingId: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏≠‡∏á</label>
                                                <input className="w-full border p-2 rounded dark:bg-gray-700" type="tel" placeholder="08xxxxxxxx" value={manageForm.phone} onChange={e => setManageForm({...manageForm, phone: e.target.value})} />
                                            </div>
                                            <button onClick={handleFindBooking} disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="animate-pop">
                                            <div className="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                                                <button onClick={() => setManageTab('info')} className={`flex-1 py-2 text-sm font-bold ${manageTab === 'info' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                                <button onClick={() => setManageTab('reschedule')} className={`flex-1 py-2 text-sm font-bold ${manageTab === 'reschedule' ? 'text-orange-600 border-b-2 border-orange-600' : 'text-gray-500'}`}>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô</button>
                                                <button onClick={() => setManageTab('food')} className={`flex-1 py-2 text-sm font-bold ${manageTab === 'food' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500'}`}>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                                            </div>

                                            {manageTab === 'info' && (
                                                <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 p-4 rounded-lg mb-6">
                                                    <div className="text-center mb-2"><span className="bg-blue-600 text-white px-2 py-1 rounded text-xs">{manageData.status}</span></div>
                                                    <h3 className="text-lg font-bold text-center mb-4">{manageData.name}</h3>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex justify-between"><span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</span> <b>{formatThaiDate(manageData.checkIn)}</b></div>
                                                        <div className="flex justify-between"><span>‡∏≠‡∏≠‡∏Å:</span> <b>{formatThaiDate(manageData.checkOut)}</b></div>
                                                        <div className="flex justify-between"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</span> <b>{manageData.guests} ‡∏Ñ‡∏ô</b></div>
                                                        <div className="flex justify-between"><span>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å:</span> <span>{manageData.rooms}</span></div>
                                                    </div>
                                                    
                                                    <div className="mt-4 pt-4 border-t border-blue-200 dark:border-blue-700">
                                                        <h4 className="font-bold text-sm text-blue-800 dark:text-blue-300 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>
                                                        <p className="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">{manageData.food}</p>
                                                    </div>

                                                    <button onClick={() => setManageData(null)} className="w-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 rounded-lg font-bold mt-4 text-sm">‡∏õ‡∏¥‡∏î</button>
                                                </div>
                                            )}

                                            {manageTab === 'reschedule' && (
                                                <div>
                                                    <div className="bg-yellow-50 dark:bg-yellow-900/20 text-xs p-2 rounded mb-4 text-yellow-800 dark:text-yellow-200">
                                                        ‚ö†Ô∏è ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
                                                    </div>
                                                    <div className="space-y-3 mb-6">
                                                        <div>
                                                            <label className="block text-xs font-bold mb-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                                            <input type="date" min={getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700" onChange={e => setRescheduleDates({...rescheduleDates, checkIn: e.target.value})} />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs font-bold mb-1">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà</label>
                                                            <input type="date" min={rescheduleDates.checkIn || getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700" onChange={e => setRescheduleDates({...rescheduleDates, checkOut: e.target.value})} />
                                                        </div>
                                                    </div>
                                                    <button onClick={handleCustomerReschedule} disabled={loading} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold shadow hover:bg-orange-700">
                                                        {loading ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...‡∏£‡∏≠‡∏™‡∏∏‡∏Å‡∏Ñ‡∏£‡∏π‡πà' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô'}
                                                    </button>
                                                </div>
                                            )}

                                            {manageTab === 'food' && (
                                                <div>
                                                    <div className="bg-green-50 dark:bg-green-900/20 text-xs p-2 rounded mb-4 text-green-800 dark:text-green-200">
                                                        üçΩÔ∏è ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mb-4 max-h-60 overflow-y-auto custom-scrollbar">
                                                        {siteConfig.foodMenu.map(f => {
                                                            const inCart = addOnCart.find(c => c.id === f.id);
                                                            return (
                                                                <div key={f.id} onClick={() => openFoodModal(f)} className={`cursor-pointer rounded-lg overflow-hidden border-2 transition-all shadow-sm relative ${inCart ? 'border-green-500 bg-green-50 dark:bg-green-900 dark:border-green-500' : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-700'}`}>
                                                                    <img src={f.img} className="w-full h-20 object-cover" />
                                                                    <div className="p-1">
                                                                        <h4 className="font-bold text-xs line-clamp-1">{f.name}</h4>
                                                                        <div className="flex justify-between items-center mt-1">
                                                                            <span className="text-green-600 text-xs font-bold">{f.price}.-</span>
                                                                            {inCart && <span className="bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">x{inCart.qty}</span>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    
                                                    {addOnCart.length > 0 && (
                                                        <div className="bg-gray-100 dark:bg-gray-700 p-3 rounded mb-4">
                                                            <h4 className="font-bold text-xs mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({addOnCart.length})</h4>
                                                            {addOnCart.map((c,i)=><div key={i} className="flex justify-between text-xs mt-1"><span>{c.name} x{c.qty}</span><button onClick={()=>setAddOnCart(addOnCart.filter((_,idx)=>idx!==i))} className="text-red-500">‡∏•‡∏ö</button></div>)}
                                                            <div className="mt-2 pt-2 border-t text-right font-bold text-sm text-green-600 mb-2">‡∏£‡∏ß‡∏° {addOnCart.reduce((sum,c)=>sum+(c.price*c.qty),0).toLocaleString()} ‡∏ö.</div>
                                                            
                                                            <div className="bg-white dark:bg-gray-800 p-3 rounded border border-gray-200 dark:border-gray-600">
                                                                <p className="text-xs font-bold mb-2 text-center">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
                                                                {addOnQr && <img src={addOnQr} className="mx-auto w-32 h-32 mb-2 border p-1" />}
                                                                <div className="text-[10px] text-center mb-2 text-gray-500">{PROMPTPAY_NAME} - {PROMPTPAY_PHONE}</div>
                                                                <input type="file" accept="image/*" onChange={async (e) => { const f = e.target.files[0]; if (f) { try { const resizedBase64 = await compressImage(f); setAddOnSlip(resizedBase64); } catch (err) { alert('Upload Error'); } } }} className="text-xs w-full mb-1" />
                                                                {!addOnSlip && <div className="text-red-500 text-[10px] text-center">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>}
                                                            </div>
                                                        </div>
                                                    )}

                                                    <button onClick={handleCustomerAddFood} disabled={loading || (addOnCart.length > 0 && !addOnSlip)} className={`w-full py-3 rounded-lg font-bold shadow transition ${loading || (addOnCart.length > 0 && !addOnSlip) ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                                                        {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ß' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {mode === 'booking' && step === 1 && (
                            <div className="max-w-md mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-xl mt-4 border dark:border-gray-700 overflow-hidden">
                                <div className="h-48 relative">
                                     <img src={siteConfig.bannerUrl} referrerPolicy="no-referrer" className="w-full h-full object-cover" />
                                     <div className="absolute inset-0 bg-black bg-opacity-10"></div>
                                </div>
                                <div className="p-6 -mt-24 relative z-10">
                                    <img src={siteConfig.logoUrl} referrerPolicy="no-referrer" className="w-48 h-48 mx-auto rounded-full border-4 border-white dark:border-gray-800 object-cover bg-white shadow-lg mb-4"/>
                                    <h1 className="text-xl text-center mb-2 text-green-800 dark:text-green-400 font-bold">{siteConfig.headerTitle}</h1>
                                    <p className="block text-center mb-4 text-gray-700 dark:text-gray-300 text-sm whitespace-pre-line">{siteConfig.headerDesc}</p>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-gray-700 dark:text-green-400 font-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
                                            <input type="date" min={getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" onChange={e => setDates({...dates, checkIn: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-gray-700 dark:text-red-300 font-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
                                            <input type="date" min={dates.checkIn || getTommorow()} className="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" onChange={e => setDates({...dates, checkOut: e.target.value})} />
                                        </div>
                                        <button onClick={handleSearch} disabled={loading} className="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition font-bold shadow-lg mt-2">{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå...‡∏£‡∏≠‡πÅ‡∏õ‡∏ö...' : '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ß‡πà‡∏≤‡∏á'}</button>
                                    </div>
                                </div>
                                {closedModal && ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-6"> <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center relative animate-pop"> <div className="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4"> <i className="fas fa-store-slash text-3xl text-red-500 dark:text-red-300"></i> </div> <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3> <p className="text-gray-600 dark:text-gray-300 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <strong>{formatThaiDate(closedModal.date)}</strong></p> <p className="text-red-500 dark:text-red-400 font-medium mb-6">"{closedModal.reason}"</p> <button onClick={() => setClosedModal(null)} className="w-full bg-gray-800 dark:bg-gray-600 text-white py-3 rounded-xl font-bold hover:bg-gray-700 transition">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button> </div> </div> )}
                                {searchError && ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-6"> <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center relative animate-pop"> <div className="w-16 h-16 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center mx-auto mb-4"> <i className="fas fa-exclamation-triangle text-3xl text-yellow-500 dark:text-yellow-300"></i> </div> <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3> <p className="text-gray-600 dark:text-gray-300 mb-6">{searchError}</p> <button onClick={() => setSearchError(null)} className="w-full bg-gray-800 dark:bg-gray-600 text-white py-3 rounded-xl font-bold hover:bg-gray-700 transition">‡∏ï‡∏Å‡∏•‡∏á</button> </div> </div> )}
                            </div>
                        )}

                        {mode === 'booking' && step === 2 && (
                            <div className="max-w-4xl mx-auto p-4 relative">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-2">
                                        <button onClick={()=>setStep(1)} className="text-gray-500 dark:text-gray-300 hover:text-green-600 font-bold"><i className="fas fa-chevron-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                        <h2 className="text-xl font-bold dark:text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h2>
                                    </div>
                                </div>
                                <div className="map-container bg-blue-100 dark:bg-gray-700 mb-6" style={{paddingBottom: '100%'}}>
                                    <img src="https://img2.pic.in.th/3d539b84-44ce-4336-ad90-bd2f84b13eca.jpg" referrerpolicy="no-referrer" className="absolute top-0 left-0 w-full h-full object-cover" />
                                    {Object.keys(pinPos).map(key => {
                                        if (!roomConfig[key]) return null;
                                        const isBooked = availability.bookedRooms.includes(key);
                                        const isZ8Full = key === 'Z8' && availability.zone8Available <= 0;
                                        const disable = isBooked || isZ8Full;
                                        const inCart = cart.find(c => c.id === key);
                                        let circleClasses = "w-12 h-12 rounded-full flex items-center justify-center text-center text-[8px] font-bold border-2 shadow-lg p-1 leading-tight transition-all duration-300";
                                        if (disable) circleClasses += " bg-gray-400 text-white border-gray-500 cursor-not-allowed opacity-80 grayscale";
                                        else if (inCart) circleClasses += " bg-yellow-400 text-black border-yellow-600 scale-110 shadow-xl z-20";
                                        else circleClasses += " bg-white dark:bg-gray-800 text-green-800 dark:text-green-400 border-green-600 hover:scale-110 z-10";
                                        return ( <div key={key} className="absolute transform -translate-x-1/2 -translate-y-1/2 map-pin-responsive" style={{left: `${pinPos[key].x}%`, top: `${pinPos[key].y}%`}} onClick={() => { if(disable) return; if(inCart) setCart(cart.filter(c => c.id !== key)); else openRoomModal(key); }}> <div className={circleClasses}> <div> {roomConfig[key].name} {key==='Z8' && <div className="text-[9px] font-normal">({availability.zone8Available})</div>} </div> </div> </div> )
                                    })}
                                </div>
                                {selectedRoomId && roomConfig[selectedRoomId] && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm relative">
                                            <div className="relative w-full h-48 mb-4 rounded-lg overflow-hidden bg-gray-200">
                                                <img src={(siteConfig.roomImages[selectedRoomId]||[])[currentImgIdx] || "https://via.placeholder.com/600x400?text=No+Image"} className="w-full h-full object-cover transition-opacity duration-300" />
                                                {(siteConfig.roomImages[selectedRoomId]||[]).length > 1 && ( <> <button onClick={prevImage} className="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70"><i className="fas fa-chevron-left"></i></button> <button onClick={nextImage} className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-1 rounded-full hover:bg-opacity-70"><i className="fas fa-chevron-right"></i></button> </> )}
                                            </div>
                                            <h3 className="text-xl font-bold mb-2 text-green-800 dark:text-green-400">{roomConfig[selectedRoomId].name}</h3>
                                            <p className="text-gray-500 dark:text-gray-300 text-sm mb-4"> {siteConfig.roomDescriptions?.[selectedRoomId] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"} </p>
                                            <div className="flex items-center justify-between mb-6 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                                <button onClick={() => setGuestCount(Math.max((parseInt(roomConfig[selectedRoomId].min)||1), guestCount - 1))} className="w-10 h-10 bg-white dark:bg-gray-600 rounded shadow text-xl font-bold text-green-600 dark:text-green-400">-</button>
                                                <div className="text-center"> <div className="text-2xl font-bold dark:text-white">{guestCount}</div> <div className="text-xs text-gray-500 dark:text-gray-400">‡∏Ñ‡∏ô</div> </div>
                                                <button onClick={() => { let limit = roomConfig[selectedRoomId].maxCap; if(selectedRoomId === 'Z8') limit = availability.zone8Available; setGuestCount(Math.min(limit, guestCount + 1)); }} className="w-10 h-10 bg-white dark:bg-gray-600 rounded shadow text-xl font-bold text-green-600 dark:text-green-400">+</button>
                                            </div>
                                            <div className="flex gap-2"> <button onClick={() => setSelectedRoomId(null)} className="flex-1 py-3 text-gray-500 bg-gray-200 dark:bg-gray-600 dark:text-gray-300 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> <button onClick={confirmRoomSelection} className="flex-1 py-3 text-white bg-green-600 hover:bg-green-700 rounded-lg font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button> </div>
                                        </div>
                                    </div>
                                )}
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4">
                                    <h3 className="font-bold mb-4 dark:text-white text-lg">üçΩÔ∏è ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {siteConfig.foodMenu.map(f => {
                                            const inCart = cart.find(c => c.id === f.id);
                                            return ( <div key={f.id} onClick={() => { if(inCart) setCart(cart.filter(c => c.id !== f.id)); else openFoodModal(f); }} className={`cursor-pointer rounded-lg overflow-hidden border-2 transition-all shadow-sm relative ${inCart ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900 dark:border-yellow-500' : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-700 hover:border-green-400'}`} > <img src={f.img} className="w-full h-24 object-cover" /> <div className="p-2"> <h4 className="font-bold text-sm text-gray-800 dark:text-white line-clamp-1">{f.name}</h4> {f.desc && <p className="text-xs text-gray-500 dark:text-gray-400 line-clamp-1 my-1">{f.desc}</p>} <div className="flex justify-between items-center mt-1"> <span className="text-green-600 dark:text-green-400 text-sm font-bold">{f.price}.-</span> {inCart && <span className="bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">x{inCart.qty}</span>} </div> </div> {inCart && <div className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow"><i className="fas fa-times"></i></div>} </div> );
                                        })}
                                    </div>
                                </div>
                                {selectedFood && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"> <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm relative animate-pop"> <img src={selectedFood.img} className="w-full h-40 object-cover rounded-lg mb-4 shadow-md" /> <h3 className="text-xl font-bold mb-1 text-green-800 dark:text-green-400">{selectedFood.name}</h3> {selectedFood.desc && <p className="text-gray-600 dark:text-gray-300 text-sm mb-2">{selectedFood.desc}</p>} <p className="text-gray-500 dark:text-gray-400 text-sm mb-4 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ä‡∏∏‡∏î‡∏•‡∏∞ {selectedFood.price} ‡∏ö‡∏≤‡∏ó</p> <div className="flex items-center justify-center gap-4 mb-6"> <button onClick={() => setFoodCount(Math.max(1, foodCount - 1))} className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full text-xl font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200">-</button> <span className="text-2xl font-bold w-10 text-center dark:text-white">{foodCount}</span> <button onClick={() => setFoodCount(foodCount + 1)} className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full text-xl font-bold text-green-600 hover:bg-green-100">+</button> </div> <div className="flex gap-2"> <button onClick={() => setSelectedFood(null)} className="flex-1 py-3 text-gray-500 bg-gray-200 dark:bg-gray-600 dark:text-gray-300 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> <button onClick={confirmFoodSelection} className="flex-1 py-3 text-white bg-green-600 hover:bg-green-700 rounded-lg font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ({selectedFood.price * foodCount}.-)</button> </div> </div> </div> )}
                                <div className="bg-gray-100 dark:bg-gray-700 p-4 rounded mb-4"><h3 className="font-bold dark:text-white">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ({cart.length})</h3> {cart.map((c,i)=><div key={i} className="flex justify-between text-sm mt-1 dark:text-gray-200"><span>{c.name} {c.type==='food'?`x${c.qty}`:`(${c.guests} ‡∏Ñ‡∏ô)`}</span><button onClick={()=>setCart(cart.filter((_,idx)=>idx!==i))} className="text-red-500">‡∏•‡∏ö</button></div>)} </div>
                                
                                {/* Step 2 -> Step 3 Button with Fake Loading */}
                                <button 
                                    onClick={() => { 
                                        const hasRoom = cart.some(c => c.type !== 'food'); 
                                        if (!hasRoom) { setShowRoomRequiredModal(true); return; } 
                                        setLoading(true);
                                        setTimeout(() => {
                                            setStep(3);
                                            setLoading(false);
                                        }, 600); 
                                    }} 
                                    className="w-full bg-green-600 text-white p-3 rounded-lg font-bold"
                                > 
                                    ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ 
                                </button>
                            </div>
                        )}

                        {mode === 'booking' && step === 3 && (
                            <div className="max-w-md mx-auto p-6 bg-white dark:bg-gray-800 shadow-xl rounded-xl">
                                <div className="flex items-center gap-2 mb-4">
                                    <button onClick={()=>setStep(2)} className="text-gray-500 dark:text-gray-300 hover:text-green-600 font-bold text-sm"><i className="fas fa-chevron-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                    <h2 className="text-xl font-bold dark:text-white">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                                </div>
                                <div className="space-y-2 mb-4 text-sm dark:text-gray-200">
                                    <p><strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</strong> {formatThaiDate(dates.checkIn)}</p>
                                    <p><strong>‡∏Ñ‡∏∑‡∏ô‡∏´‡πâ‡∏≠‡∏á:</strong> {formatThaiDate(dates.checkOut)}</p>
                                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> {calculateNights()} ‡∏Ñ‡∏∑‡∏ô</p>
                                    {pricing.isHighSeason && <div className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-1 rounded">‚ÑπÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•/‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏Ñ‡∏¥‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥ 100%</div>}
                                    <hr className="dark:border-gray-600"/>
                                    
                                    {/* [NEW] Updated Render Loop for Step 3 */}
                                    {cart.map((c, i) => {
                                        const nights = calculateNights();
                                        let itemPrice = 0;
                                        if (c.type === 'food') {
                                            itemPrice = c.price * c.qty;
                                        } else if (c.id === 'Z8') {
                                            itemPrice = c.pricePerNight * nights * c.guests;
                                        } else {
                                            itemPrice = c.pricePerNight * nights;
                                        }
                                        return (
                                            <div key={i} className="flex justify-between">
                                                <span>{c.name} {c.type === 'food' ? `x${c.qty}` : (c.id === 'Z8' ? `(${c.guests} ‡∏Ñ‡∏ô)` : '')}</span>
                                                <span>{itemPrice.toLocaleString()} ‡∏ö.</span>
                                            </div>
                                        );
                                    })}
                                    
                                    <hr className="dark:border-gray-600"/>
                                    {pricing.discount > 0 && <div className="flex justify-between text-red-500 font-bold"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</span><span>-{pricing.discount} ‡∏ö.</span></div>}
                                    <div className="flex justify-between font-bold text-lg"><span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>{pricing.netTotal.toLocaleString()} ‡∏ö.</span></div>
                                    <div className="bg-yellow-100 dark:bg-yellow-900 p-2 rounded text-center border border-yellow-300 dark:border-yellow-700 mt-2">
                                        <span className="block text-sm text-yellow-800 dark:text-yellow-200">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô</span>
                                        <span className="text-2xl font-bold text-red-600 dark:text-red-400">{pricing.deposit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <div className="flex gap-2"> <input placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" className="border p-2 rounded flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" onChange={e => setDiscount({...discount, code: e.target.value})} /> <button className="bg-gray-800 dark:bg-gray-600 text-white px-4 rounded" onClick={checkDiscountCode}>‡∏Å‡∏î‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button> </div>
                                    {discount.message && <p className={`text-xs mt-1 ${discount.status==='success'?'text-green-600 dark:text-green-400':'text-red-500 dark:text-red-400'}`}>{discount.message}</p>}
                                </div>
                                <div className="space-y-3 mb-6">
                                    <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" className="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={customer.name} onChange={e => setCustomer({...customer, name: e.target.value})} />
                                    <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" className="w-full border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" type="tel" value={customer.phone} onChange={e => setCustomer({...customer, phone: e.target.value})} />
                                </div>
                                <div className="text-center mb-6">
                                    <p className="mb-2 font-bold dark:text-white">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå)</p>
                                    {qrUrl ? ( <div className="flex flex-col items-center"> <img src={qrUrl} className="mx-auto border-2 border-gray-200 dark:border-gray-600 rounded-lg mb-3 shadow-sm p-1 bg-white" alt="QR Code" width="200" height="200" /> <p className="text-sm text-blue-600 dark:text-blue-400 font-bold mt-2"> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p> </div> ) : ( <div className="h-[200px] flex items-center justify-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...</div> )}
                                    <div className="mt-4 bg-gray-50 dark:bg-gray-700 p-2 rounded"> <p className="text-sm font-bold text-gray-800 dark:text-white">{PROMPTPAY_NAME}</p> <p className="text-xs text-gray-500 dark:text-gray-400 font-mono tracking-wider">{PROMPTPAY_PHONE}</p> </div>
                                </div>
                                <div className="mb-4"> <label className="block mb-1 text-sm dark:text-gray-300">‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <span className="text-red-500">*</span></label> <input type="file" accept="image/*" onChange={async (e) => { const f = e.target.files[0]; if (f) { try { const resizedBase64 = await compressImage(f); setSlipImg(resizedBase64); } catch (err) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'); } } }} className="w-full text-sm dark:text-gray-300" /> </div>
                                <div className="flex items-start gap-2 mb-4 text-xs text-gray-600 dark:text-gray-400"> <input type="checkbox" className="mt-1" checked={agreed} onChange={e => setAgreed(e.target.checked)} /> <p>‡∏â‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ </p> </div>
                                <button onClick={handleSubmit} disabled={loading || !canSubmit} className={`w-full p-3 rounded-lg font-bold text-white transition ${loading || !canSubmit ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå...' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'}</button>
                            </div>
                        )}

                        {mode === 'booking' && step === 5 && (
                            <div className="max-w-md mx-auto p-10 text-center bg-white dark:bg-gray-800 shadow-xl rounded-xl mt-10">
                                <div className="text-6xl mb-4">üéâ</div>
                                <h2 className="text-2xl font-bold text-green-700 dark:text-green-400 mb-2">‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                                <p className="text-gray-600 dark:text-gray-300 mb-4">‡∏£‡∏´‡∏±‡∏™: <strong>{bookingResult}</strong></p>
                                <p className="text-l text-gray-400 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏à‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö</p>
                                <p className="text-sm text-gray-500 mb-4">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç : ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ</p>
                                <p className="text-sm text-gray-500 mb-4">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ß‡∏±‡∏ô</p>
                                <p className="text-sm text-gray-500 mb-4">‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ</p>
                                <button onClick={() => liff.closeWindow()} className="mt-8 bg-gray-800 dark:bg-gray-600 text-white px-6 py-2 rounded-full">‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ô‡∏∞</button>
                            </div>
                        )}
                        
                        {showRoomRequiredModal && ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-6"> <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center relative animate-pop transform scale-100 transition-all"> <div className="w-20 h-20 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white dark:border-gray-700 shadow-lg"> <i className="fas fa-bed text-4xl text-red-500 dark:text-red-300"></i> </div> <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h3> <p className="text-gray-600 dark:text-gray-300 mb-6 text-sm leading-relaxed"> ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° <br/> <span className="text-red-500 font-bold">‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô</span><br/> ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö </p> <button onClick={() => setShowRoomRequiredModal(false)} className="w-full bg-gray-800 dark:bg-gray-600 text-white py-3 rounded-xl font-bold hover:bg-gray-700 transition shadow-lg"> ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö </button> </div> </div> )}

                        {selectedFood && ( 
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"> 
                                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm relative animate-pop"> 
                                    <img src={selectedFood.img} className="w-full h-40 object-cover rounded-lg mb-4 shadow-md" /> 
                                    <h3 className="text-xl font-bold mb-1 text-green-800 dark:text-green-400">{selectedFood.name}</h3> 
                                    {selectedFood.desc && <p className="text-gray-600 dark:text-gray-300 text-sm mb-2">{selectedFood.desc}</p>} 
                                    <p className="text-gray-500 dark:text-gray-400 text-sm mb-4 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ä‡∏∏‡∏î‡∏•‡∏∞ {selectedFood.price} ‡∏ö‡∏≤‡∏ó</p> 
                                    <div className="flex items-center justify-center gap-4 mb-6"> 
                                        <button onClick={() => setFoodCount(Math.max(1, foodCount - 1))} className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full text-xl font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200">-</button> 
                                        <span className="text-2xl font-bold w-10 text-center dark:text-white">{foodCount}</span> 
                                        <button onClick={() => setFoodCount(foodCount + 1)} className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full text-xl font-bold text-green-600 hover:bg-green-100">+</button> 
                                    </div> 
                                    <div className="flex gap-2"> 
                                        <button onClick={() => setSelectedFood(null)} className="flex-1 py-3 text-gray-500 bg-gray-200 dark:bg-gray-600 dark:text-gray-300 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> 
                                        <button onClick={confirmFoodSelection} className="flex-1 py-3 text-white bg-green-600 hover:bg-green-700 rounded-lg font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ({selectedFood.price * foodCount}.-)</button> 
                                    </div> 
                                </div> 
                            </div> 
                        )}

                        {modalAlert.show && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity">
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 animate-pop">
                                    <div className={`p-6 text-center ${
                                        modalAlert.type === 'error' ? 'bg-red-50 dark:bg-red-900/30' : 
                                        modalAlert.type === 'success' ? 'bg-green-50 dark:bg-green-900/30' : 
                                        modalAlert.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/30' : 'bg-blue-50 dark:bg-blue-900/30'
                                    }`}>
                                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm ${
                                            modalAlert.type === 'error' ? 'bg-red-100 text-red-500' : 
                                            modalAlert.type === 'success' ? 'bg-green-100 text-green-500' : 
                                            modalAlert.type === 'warning' ? 'bg-yellow-100 text-yellow-500' : 'bg-blue-100 text-blue-500'
                                        }`}>
                                            <i className={`fas ${
                                                modalAlert.type === 'error' ? 'fa-times' : 
                                                modalAlert.type === 'success' ? 'fa-check' : 
                                                modalAlert.type === 'warning' ? 'fa-exclamation' : 'fa-info'
                                            } text-3xl`}></i>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">{modalAlert.title}</h3>
                                        <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">{modalAlert.text}</p>
                                    </div>
                                    <div className="p-4 bg-gray-50 dark:bg-gray-700">
                                        <button 
                                            onClick={() => setModalAlert({ ...modalAlert, show: false })} 
                                            className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95 ${
                                                modalAlert.type === 'error' ? 'bg-red-500 hover:bg-red-600' : 
                                                modalAlert.type === 'success' ? 'bg-green-500 hover:bg-green-600' : 
                                                modalAlert.type === 'warning' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700'
                                            }`}
                                        >
                                            ‡∏ï‡∏Å‡∏•‡∏á
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {modalConfirm.show && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity">
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 animate-pop">
                                    <div className="p-6 text-center bg-white dark:bg-gray-800">
                                        <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                                            <i className="fas fa-question text-3xl"></i>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">{modalConfirm.title}</h3>
                                        <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed whitespace-pre-line">{modalConfirm.text}</p>
                                    </div>
                                    <div className="p-4 bg-gray-50 dark:bg-gray-700 flex gap-3">
                                        <button 
                                            onClick={() => setModalConfirm({ ...modalConfirm, show: false })}
                                            className="flex-1 py-3 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-bold hover:bg-gray-100 dark:hover:bg-gray-500 transition shadow-sm"
                                        >
                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                        </button>
                                        <button 
                                            onClick={modalConfirm.onConfirm}
                                            className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg transform active:scale-95"
                                        >
                                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {checkingDiscount && (
                            <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm transition-opacity">
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center animate-pop">
                                    <div className="w-12 h-12 border-4 border-gray-200 border-t-green-500 rounded-full animate-spin mx-auto mb-4"></div>
                                    <h3 className="text-lg font-bold text-gray-800 dark:text-white">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î...</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">‡πÄ‡∏ï‡∏µ‡∏¢‡∏°‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡πÅ‡∏õ‡∏ö...‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
