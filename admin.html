<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบหลังบ้าน - ขนำลุงดำ แคมป์ปิ้ง</title>
    
    <!-- React & Libs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .calendar-day { min-height: 80px; }
        @media(max-width: 640px){ .calendar-day { min-height: 50px; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-modal { animation: popIn 0.2s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        #print-container { display: none; }
        @media print {
            @page { size: A4; margin: 0; }
            .no-print, .no-print * { display: none !important; }
            body, html { margin: 0; padding: 0; background: white; height: 100%; overflow: visible !important; }
            #print-container { 
                position: absolute !important; 
                left: 0 !important; 
                top: 0 !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                display: block !important; 
                background: white; 
                z-index: 9999; 
                visibility: visible !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            #receipt-print-area { width: 210mm; min-height: 297mm; padding: 10mm 15mm; display: block !important; }
            #report-print-area { width: 210mm; min-height: 297mm; padding: 10mm 10mm; display: block !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMqbjDfim6sg2xOUL2FFXmEByd9SYhlXWjyZizH-rx7DoKR5uVIQlLrQIUh8UFidna/exec"; 
        
        let ROOM_IDS = [];
        let ROOM_NAMES = {};

        // Tab Names Mapping (Thai)
        const TAB_NAMES = {
            dashboard: 'ภาพรวม',
            bookings: 'รายการจอง',
            calendar: 'ปฏิทิน',
            rooms: 'จัดการห้องพัก',
            settings: 'ตั้งค่าระบบ'
        };

        // Filter Names Mapping (Thai)
        const FILTER_NAMES = {
            all: 'ทั้งหมด',
            pending: 'รอตรวจสอบ',
            confirmed: 'ยืนยัน',
            upcoming: 'เร็วๆ นี้'
        };

        const compressImage = async (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 800;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const StatusBadge = ({ status }) => {
            let color = 'bg-gray-100 text-gray-800';
            const safeStatus = String(status || '');
            if (safeStatus === 'รอตรวจสอบ') color = 'bg-yellow-100 text-yellow-800';
            if (safeStatus === 'ยืนยัน') color = 'bg-green-100 text-green-800';
            if (safeStatus.includes('ยกเลิก')) color = 'bg-red-100 text-red-800';
            return <span className={`px-2 py-1 rounded text-xs font-bold border ${color}`}>{safeStatus}</span>;
        };

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            
            const [bookings, setBookings] = React.useState([]);
            const [settings, setSettings] = React.useState({ discounts: [], closed: [], special: [], roomClosures: [] });
            const [siteSettings, setSiteSettings] = React.useState(null);
            const [savingSiteSettings, setSavingSiteSettings] = React.useState(false);
            const [roomConfig, setRoomConfig] = React.useState({});
            const [mapConfig, setMapConfig] = React.useState({}); 

            const [viewSlip, setViewSlip] = React.useState(null); 
            const [viewBooking, setViewBooking] = React.useState(null); 
            const [filter, setFilter] = React.useState('all'); 
            const [searchTerm, setSearchTerm] = React.useState(''); 
            const [printMode, setPrintMode] = React.useState('none'); // 'receipt' or 'report'

            const [rescheduleData, setRescheduleData] = React.useState({ checkIn: '', checkOut: '' });
            const [selectedAddFood, setSelectedAddFood] = React.useState('');
            const [addFoodQty, setAddFoodQty] = React.useState(1);
            const [customItem, setCustomItem] = React.useState({ name: '', price: '', qty: 1 });

            // Settings Forms
            const [editMode, setEditMode] = React.useState(null); 
            const [formDiscount, setFormDiscount] = React.useState({ code: '', type: 'FIXED', value: '' });
            const [formClosed, setFormClosed] = React.useState({ startDate: '', endDate: '', reason: '' });
            const [formSpecial, setFormSpecial] = React.useState({ startDate: '', endDate: '', desc: '' });
            const [formRoomClosure, setFormRoomClosure] = React.useState({ startDate: '', endDate: '', roomId: '', reason: '' });
            const [newFood, setNewFood] = React.useState({ id: '', name: '', price: '', img: '', desc: '' });
            const [selectedRoomForImg, setSelectedRoomForImg] = React.useState('');
            
            // Room Management States
            const [isRoomModalOpen, setIsRoomModalOpen] = React.useState(false);
            const [editingRoom, setEditingRoom] = React.useState(null);
            const [formRoom, setFormRoom] = React.useState({ roomId: '', name: '', type: 'room', min: 1, max: 2, pricing: '', bf: true, posX: 50, posY: 50, desc: '' });

            const [showAdminBooking, setShowAdminBooking] = React.useState(false);
            const [adminBookingForm, setAdminBookingForm] = React.useState({ name: '', phone: '', checkIn: '', checkOut: '', rooms: [], price: '', deposit: '' });
            const [adminAvailability, setAdminAvailability] = React.useState(null); 
            const [loadingAvailability, setLoadingAvailability] = React.useState(false);

            const [calendarDate, setCalendarDate] = React.useState(new Date());
            const [modal, setModal] = React.useState({ isOpen: false, type: 'alert', title: '', message: '', onConfirm: null });

            const showModal = (title, message, type = 'alert', onConfirm = null) => { setModal({ isOpen: true, title, message, type, onConfirm }); };
            const closeModal = () => setModal(prev => ({ ...prev, isOpen: false }));
            const alertMsg = (message, title = 'แจ้งเตือน', type = 'warning') => showModal(title, message, type, closeModal);
            const successMsg = (message) => alertMsg(message, 'สำเร็จ', 'success');
            const errorMsg = (message) => alertMsg(message, 'เกิดข้อผิดพลาด', 'error');
            const confirmMsg = (message, onConfirm) => showModal('ยืนยันการทำรายการ', message, 'confirm', () => { closeModal(); onConfirm(); });

            const formatThaiDate = (dateStr) => {
                if(!dateStr || dateStr === '-') return "-";
                const date = new Date(dateStr);
                const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
            };

            React.useEffect(() => {
                if (showAdminBooking && adminBookingForm.checkIn && adminBookingForm.checkOut) {
                    if (adminBookingForm.checkIn < adminBookingForm.checkOut) {
                        setLoadingAvailability(true);
                        setAdminBookingForm(prev => ({...prev, rooms: []})); 
                        fetch(`${GOOGLE_SCRIPT_URL}?action=getAvailability&checkIn=${adminBookingForm.checkIn}&checkOut=${adminBookingForm.checkOut}`)
                            .then(r => r.json())
                            .then(res => { setLoadingAvailability(false); if (res.status === 'success') setAdminAvailability(res); })
                            .catch(e => setLoadingAvailability(false));
                    }
                } else { setAdminAvailability(null); }
            }, [showAdminBooking, adminBookingForm.checkIn, adminBookingForm.checkOut]);

            const stats = React.useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const totalRevenue = bookings.filter(b => b.status === 'ยืนยัน').reduce((sum, b) => sum + parseInt(b.deposit || 0), 0);
                const monthlyRevenue = bookings.filter(b => { const d = new Date(b.checkIn); return b.status === 'ยืนยัน' && d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((sum, b) => sum + parseInt(b.deposit || 0), 0);
                const pendingCount = bookings.filter(b => b.status === 'รอตรวจสอบ').length;
                const monthlyCounts = Array(12).fill(0);
                bookings.forEach(b => { 
                    if (b.status !== 'ยกเลิก' && b.status !== 'Cancelled') { 
                        const d = new Date(b.checkIn); 
                        if (d.getFullYear() === currentYear) { monthlyCounts[d.getMonth()]++; } 
                    } 
                });
                const upcoming = bookings.filter(b => { 
                    const checkIn = new Date(b.checkIn); 
                    const diffTime = checkIn - now; 
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return b.status === 'ยืนยัน' && diffDays >= 0 && diffDays <= 3; 
                }).sort((a,b) => new Date(a.checkIn) - new Date(b.checkIn));
                
                const monthlyData = monthlyCounts.map((count, index) => ({
                    month: ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][index],
                    count: count,
                    height: count > 0 ? Math.max(10, (count / Math.max(...monthlyCounts)) * 100) : 0
                }));

                return { totalRevenue, monthlyRevenue, pendingCount, upcoming, monthlyData };
            }, [bookings]);

            const filteredBookings = React.useMemo(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                let result = bookings.filter(b => {
                    const bCheckIn = new Date(b.checkIn); bCheckIn.setHours(0,0,0,0);
                    let statusMatch = false;
                    if (filter === 'all') statusMatch = true;
                    else if (filter === 'pending') statusMatch = b.status === 'รอตรวจสอบ';
                    else if (filter === 'confirmed') statusMatch = b.status === 'ยืนยัน'; 
                    else if (filter === 'upcoming') statusMatch = b.status === 'ยืนยัน' && bCheckIn >= today;
                    else if (filter === 'history') statusMatch = b.status === 'ยืนยัน' && bCheckIn < today;
                    if (!statusMatch) return false;
                    const term = searchTerm.toLowerCase();
                    return String(b.id).toLowerCase().includes(term) || String(b.name).toLowerCase().includes(term) || String(b.phone).includes(term);
                });
                if (filter === 'upcoming') result.sort((a, b) => new Date(a.checkIn) - new Date(b.checkIn));
                return result;
            }, [bookings, filter, searchTerm]);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adminLogin', password: password }) })
                .then(r => r.json()).then(res => {
                    setLoading(false);
                    if (res.status === 'success') { setIsLoggedIn(true); fetchData(); fetchSettings(); fetchRoomConfig(); } else errorMsg('รหัสผ่านไม่ถูกต้อง');
                }).catch(err => { setLoading(false); errorMsg('Connection Error: ' + err); });
            };

            const fetchData = () => {
                setLoading(true);
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAdminData', password: password }) })
                .then(r => r.json()).then(res => { setLoading(false); if (res.status === 'success') setBookings(res.data); });
            };

            const fetchSettings = () => {
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSettings', password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') setSettings(res); });
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSiteSettings', password: password }) }).then(r => r.json()).then(res => { if (res.status === 'success') setSiteSettings(res.data); });
            };

            const fetchRoomConfig = () => {
                Promise.all([
                    fetch(`${GOOGLE_SCRIPT_URL}?action=getRoomConfig`).then(r => r.json()),
                    fetch(`${GOOGLE_SCRIPT_URL}?action=getMapConfig`).then(r => r.json())
                ]).then(([roomRes, mapRes]) => {
                    if (roomRes.status === 'success') {
                        setRoomConfig(roomRes.data);
                        ROOM_IDS = Object.keys(roomRes.data);
                        ROOM_NAMES = {};
                        ROOM_IDS.forEach(id => ROOM_NAMES[id] = roomRes.data[id].name);
                    }
                    if (mapRes.status === 'success') {
                        setMapConfig(mapRes.data);
                    }
                });
            };

            const handleSaveRoom = () => {
                if(!formRoom.roomId || !formRoom.name || !formRoom.pricing) return alertMsg('กรุณากรอกข้อมูลให้ครบ (ID, ชื่อ, ราคา)');
                confirmMsg('ยืนยันบันทึกข้อมูลห้องพัก?', () => {
                    setLoading(true);
                    const updatedDescriptions = { ...siteSettings.roomDescriptions, [formRoom.roomId]: formRoom.desc };
                    const updatedSiteSettings = { ...siteSettings, roomDescriptions: updatedDescriptions };
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveRoom', password: password, ...formRoom })})
                    .then(r => r.json()).then(res => {
                        if(res.status === 'success') {
                            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSiteSettings', password, settings: updatedSiteSettings })})
                            .then(r2 => r2.json()).then(res2 => {
                                setLoading(false);
                                if(res2.status === 'success') { successMsg('บันทึกห้องพักและคำอธิบายเรียบร้อย'); setSiteSettings(updatedSiteSettings); fetchRoomConfig(); setIsRoomModalOpen(false); } else { errorMsg('บันทึกคำอธิบายไม่สำเร็จ: ' + res2.message); }
                            });
                        } else { setLoading(false); errorMsg('บันทึกไม่สำเร็จ: ' + res.message); }
                    });
                });
            };

            const handleDeleteRoom = (roomId) => {
                confirmMsg(`ยืนยันลบห้อง ${roomId}?`, () => {
                    setLoading(true);
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteRoom', password: password, roomId }) })
                    .then(r => r.json()).then(res => {
                        setLoading(false);
                        if(res.status === 'success') { successMsg('ลบห้องพักเรียบร้อย'); fetchRoomConfig(); } else errorMsg('ลบไม่สำเร็จ');
                    });
                });
            };

            const openRoomModal = (room = null) => {
                if(room) {
                    setEditingRoom(room);
                    const mapPos = mapConfig[room.id] || {x:50, y:50};
                    const desc = siteSettings?.roomDescriptions?.[room.id] || '';
                    setFormRoom({ roomId: room.id, name: room.name, type: room.type, min: room.min, max: room.maxCap, pricing: JSON.stringify(room.pricing), bf: room.bf, posX: mapPos.x, posY: mapPos.y, desc: desc });
                } else {
                    setEditingRoom(null);
                    setFormRoom({ roomId: '', name: '', type: 'room', min: 1, max: 2, pricing: '{"tiers":[{"max":2,"price":1500}]}', bf: true, posX: 50, posY: 50, desc: '' });
                }
                setIsRoomModalOpen(true);
            };

            const updateStatus = (id, s) => { confirmMsg(`ยืนยันเปลี่ยนสถานะเป็น ${s}?`, ()=>{ setBookings(p=>p.map(b=>b.id===id?{...b,status:s}:b)); fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'updateStatus', bookingId:id, newStatus:s, password:password})}); if(viewBooking?.id===id)setViewBooking(prev=>({...prev,status:s})); }); };
            
            const handleCreateAdminBooking = () => {
                const { name, phone, checkIn, checkOut, rooms, price, deposit } = adminBookingForm;
                if(!name || !phone || !checkIn || !checkOut || rooms.length === 0 || !price) return alertMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
                confirmMsg('ยืนยันสร้างรายการจอง?', () => {
                    setLoading(true);
                    const cart = rooms.map(rid => ({ id: rid, name: ROOM_NAMES[rid] || rid, type: (rid==='Z8'?'ground':(rid.startsWith('K')?'tent_rent':(rid.startsWith('T')?'tent':'room'))), guests: 2, qty: 1 }));
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'createAdminBooking', password: password, customer: { name, phone }, checkIn, checkOut, totalGuests: 2, cart: cart, price: parseFloat(price), deposit: parseFloat(deposit || price) })
                    }).then(r => r.json()).then(res => { setLoading(false); if(res.status === 'success') { successMsg('สร้างรายการจองสำเร็จ'); fetchData(); setShowAdminBooking(false); setAdminBookingForm({ name: '', phone: '', checkIn: '', checkOut: '', rooms: [], price: '', deposit: '' }); setAdminAvailability(null); } else errorMsg('ไม่สำเร็จ: ' + res.message); });
                });
            };

            const handleReschedule = () => {
                if(!viewBooking) return;
                if(!rescheduleData.checkIn || !rescheduleData.checkOut) return alertMsg('กรุณาเลือกวันที่ให้ครบถ้วน');
                if(rescheduleData.checkIn >= rescheduleData.checkOut) return alertMsg('วันที่ออกต้องอยู่หลังวันที่เข้าพัก');
                confirmMsg('ยืนยันการเลื่อนวันเข้าพัก?', () => {
                    setLoading(true);
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'rescheduleBooking', bookingId: viewBooking.id, newCheckIn: rescheduleData.checkIn, newCheckOut: rescheduleData.checkOut, password: password }) 
                    }).then(r => r.json()).then(res => { 
                        setLoading(false);
                        if (res.status === 'success') { successMsg('เลื่อนวันสำเร็จเรียบร้อย'); setRescheduleData({checkIn:'', checkOut:''}); setViewBooking(null); fetchData(); } 
                        else errorMsg('ไม่สำเร็จ: ' + res.message); 
                    });
                });
            };

            const handleAddFood = () => {
                if(!viewBooking) return;
                if(!selectedAddFood) return alertMsg('กรุณาเลือกเมนูอาหาร');
                const foodItem = siteSettings.foodMenu.find(f => f.id === selectedAddFood);
                if(!foodItem) return;
                confirmMsg(`ยืนยันเพิ่ม ${foodItem.name} จำนวน ${addFoodQty} ชุด?`, () => {
                    setLoading(true);
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addFoodToBooking', bookingId: viewBooking.id, foodItem: { id: foodItem.id, name: foodItem.name, price: foodItem.price, qty: parseInt(addFoodQty) }, password: password })
                    }).then(r => r.json()).then(res => { 
                        setLoading(false); 
                        if(res.status === 'success') { successMsg('เพิ่มรายการอาหารเรียบร้อย'); fetchData(); setViewBooking(null); } 
                        else { errorMsg('Error: ' + res.message); } 
                    });
                });
            };

            const handleAddCustomItem = () => {
                if(!viewBooking) return;
                if(!customItem.name || !customItem.price) return alertMsg('กรุณาระบุชื่อรายการและราคา');
                confirmMsg(`ยืนยันเพิ่มรายการ "${customItem.name}" ยอดรวม ${customItem.price * customItem.qty} บาท?`, () => {
                    setLoading(true);
                    const newItem = { 
                        id: 'CUST-' + Date.now(), 
                        name: customItem.name, 
                        price: parseFloat(customItem.price), 
                        qty: parseInt(customItem.qty) 
                    };
                    fetch(GOOGLE_SCRIPT_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ 
                            action: 'addFoodToBooking',
                            bookingId: viewBooking.id, 
                            foodItem: newItem, 
                            password: password 
                        })
                    }).then(r => r.json()).then(res => { 
                        setLoading(false); 
                        if(res.status === 'success') { 
                            successMsg('บันทึกรายการเพิ่มเรียบร้อย'); 
                            setCustomItem({ name: '', price: '', qty: 1 }); 
                            fetchData(); 
                            setViewBooking(null); 
                        } else { 
                            errorMsg('Error: ' + res.message); 
                        } 
                    });
                });
            };

            const handleSaveSetting = (t,p) => { 
                if(t !== 'discount' && (!p.startDate || !p.endDate)) return alertMsg('กรุณาระบุวันเริ่มต้นและสิ้นสุด');
                if(t !== 'discount' && p.startDate > p.endDate) return alertMsg('วันเริ่มต้นต้องมาก่อนวันสิ้นสุด');
                const a=editMode?'editSetting':'addSetting'; const id=editMode?.id; 
                confirmMsg('ยืนยันบันทึก?', ()=>{ 
                    fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify({action:a,type:t,id,payload:p,password})}).then(r=>r.json()).then(res=>{if(res.status==='success'){successMsg('สำเร็จ');fetchSettings();setEditMode(null);}else errorMsg('Error');}); 
                }); 
            };
            const handleDeleteSetting = (t,id) => confirmMsg('ลบรายการ?', ()=>{ fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'deleteSetting',type:t,id,password})}).then(r=>r.json()).then(res=>{if(res.status==='success')fetchSettings();}); });
            const handleSaveSiteSettings = () => confirmMsg('บันทึกร้านค้า?', ()=>{ setSavingSiteSettings(true); fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'saveSiteSettings',password,settings:siteSettings})}).then(r=>r.json()).then(res=>{setSavingSiteSettings(false);if(res.status==='success'){successMsg('สำเร็จ');fetchSettings();}else errorMsg('Error');}); });
            const handleImageUpload = async (f,cb) => { if(f) cb(await compressImage(f)); };
            const handleMultipleImageUpload = async (files,cb) => { const p = Array.from(files).map(f=>compressImage(f)); cb(await Promise.all(p)); };
            
            // [MODIFIED] Print Functions
            const handlePrintReceipt = () => {
                setPrintMode('receipt');
                setTimeout(() => { window.print(); }, 200);
            };

            const handlePrintReport = () => {
                setPrintMode('report');
                setTimeout(() => { window.print(); }, 200);
            };

            const addFoodItem = () => {
                if(!newFood.name || !newFood.price) return alertMsg('ใส่ชื่อและราคาให้ครบ');
                const newItem = { ...newFood, id: 'F' + Date.now() };
                const updatedMenu = [...(siteSettings.foodMenu||[]), newItem];
                setSiteSettings({...siteSettings, foodMenu: updatedMenu});
                setNewFood({ id: '', name: '', price: '', img: '', desc: '' });
            };
            const removeFoodItem = (id) => {
                setSiteSettings({...siteSettings, foodMenu: siteSettings.foodMenu.filter(f => f.id !== id)});
            };
            const moveFoodItem = (idx, direction) => {
                const menu = [...(siteSettings.foodMenu || [])];
                if (direction === 'up' && idx > 0) {
                    [menu[idx], menu[idx - 1]] = [menu[idx - 1], menu[idx]];
                } else if (direction === 'down' && idx < menu.length - 1) {
                    [menu[idx], menu[idx + 1]] = [menu[idx + 1], menu[idx]];
                }
                setSiteSettings({...siteSettings, foodMenu: menu});
            };

            const addRoomImage = (b64) => {
                if(!selectedRoomForImg) return alertMsg('เลือกห้องก่อน');
                const currentImgs = siteSettings.roomImages[selectedRoomForImg] || [];
                setSiteSettings({...siteSettings, roomImages: {...siteSettings.roomImages, [selectedRoomForImg]: [...currentImgs, b64]}});
            };
            const removeRoomImage = (roomId, idx) => {
                const currentImgs = siteSettings.roomImages[roomId] || [];
                const newImgs = currentImgs.filter((_, i) => i !== idx);
                setSiteSettings({...siteSettings, roomImages: {...siteSettings.roomImages, [roomId]: newImgs}});
            };

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1).getDay();
            const days = []; for(let i=0; i<firstDayOfMonth; i++) days.push(null); for(let i=1; i<=getDaysInMonth(calendarDate); i++) days.push(i);
            const getBookingsForDate = (day) => { if(!day) return []; const dStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; return bookings.filter(b => b.status !== 'ยกเลิก' && b.checkIn <= dStr && b.checkOut > dStr); };

            if (!isLoggedIn) return ( <div className="min-h-screen flex items-center justify-center bg-gray-900 px-4"> <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm"> <h1 className="text-3xl font-bold text-center text-green-800 mb-6">Admin Login</h1> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" placeholder="Password" className="w-full p-3 border rounded-lg" value={password} onChange={e => setPassword(e.target.value)} /> <button disabled={loading} className="w-full bg-gray-800 text-white p-3 rounded-lg hover:bg-gray-700 font-bold">{loading ? '...' : 'Login'}</button> </form> </div> {modal.isOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-xl max-w-xs w-full text-center"><p className="mb-4">{modal.message}</p><button onClick={closeModal} className="bg-gray-800 text-white px-4 py-2 rounded">OK</button></div></div>} </div> );

            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    <div className="no-print">
                        <nav className="bg-white shadow p-3 sticky top-0 z-20 flex justify-between items-center">
                            <div className="font-bold text-lg text-green-800"><i className="fas fa-campground mr-2"></i>ระบบหลังบ้าน</div>
                            <div className="flex gap-2"><button onClick={fetchData} className="w-8 h-8 bg-gray-100 rounded-full hover:bg-gray-200"><i className="fas fa-sync"></i></button><button onClick={()=>window.location.reload()} className="w-8 h-8 bg-red-50 text-red-500 rounded-full hover:bg-red-100"><i className="fas fa-power-off"></i></button></div>
                        </nav>
                        <div className="max-w-7xl mx-auto p-3 md:p-6">
                            <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                                {['dashboard','bookings','calendar','rooms','settings'].map(t=>(<button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab===t?'bg-green-600 text-white shadow-lg':'bg-white text-gray-600 shadow'}`}>{TAB_NAMES[t]}</button>))}
                            </div>

                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between h-32 relative overflow-hidden group">
                                            <div className="z-10">
                                                <p className="text-green-100 text-sm font-medium">รายได้รวม</p>
                                                <h3 className="text-3xl font-bold mt-1">{stats.totalRevenue.toLocaleString()} ฿</h3>
                                            </div>
                                            <i className="fas fa-coins text-6xl absolute -right-2 -bottom-4 opacity-20 group-hover:opacity-30 transition-opacity"></i>
                                        </div>
                                        <div className="bg-gradient-to-br from-yellow-400 to-orange-500 p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between h-32 relative overflow-hidden group">
                                            <div className="z-10">
                                                <p className="text-yellow-100 text-sm font-medium">รอตรวจสอบ</p>
                                                <h3 className="text-3xl font-bold mt-1">{stats.pendingCount} รายการ</h3>
                                            </div>
                                            <i className="fas fa-clock text-6xl absolute -right-2 -bottom-4 opacity-20 group-hover:opacity-30 transition-opacity"></i>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-500 to-indigo-600 p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between h-32 relative overflow-hidden group">
                                            <div className="z-10">
                                                <p className="text-purple-100 text-sm font-medium">การจองทั้งหมด</p>
                                                <h3 className="text-3xl font-bold mt-1">{bookings.length} รายการ</h3>
                                            </div>
                                            <i className="fas fa-book text-6xl absolute -right-2 -bottom-4 opacity-20 group-hover:opacity-30 transition-opacity"></i>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-400 to-cyan-500 p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between h-32 relative overflow-hidden group">
                                            <div className="z-10">
                                                <p className="text-blue-100 text-sm font-medium">เข้าพักเร็วๆนี้</p>
                                                <h3 className="text-3xl font-bold mt-1">{stats.upcoming.length} รายการ</h3>
                                            </div>
                                            <i className="fas fa-suitcase-rolling text-6xl absolute -right-2 -bottom-4 opacity-20 group-hover:opacity-30 transition-opacity"></i>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-lg shadow">
                                            <h3 className="font-bold text-lg mb-4 text-blue-800 border-b pb-2"><i className="fas fa-clock mr-2"></i>เข้าพักเร็วๆ นี้ (3 วัน)</h3>
                                            {stats.upcoming.length === 0 ? <p className="text-gray-400 text-center py-4">ไม่มีรายการ</p> : (
                                                <ul className="divide-y">
                                                    {stats.upcoming.map((b,i) => (
                                                        <li key={i} className="py-3 flex justify-between items-center cursor-pointer hover:bg-blue-50 transition p-2 rounded" onClick={()=>setViewBooking(b)}>
                                                            <div className="flex items-center gap-3">
                                                                <div className="bg-blue-100 text-blue-600 p-2 rounded-lg text-center min-w-[50px]">
                                                                    <div className="text-xs font-bold">{new Date(b.checkIn).getDate()}</div>
                                                                    <div className="text-[10px]">{["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][new Date(b.checkIn).getMonth()]}</div>
                                                                </div>
                                                                <div>
                                                                    <div className="font-bold text-gray-800">{b.name}</div>
                                                                    <div className="text-xs text-gray-500">{b.rooms.split(',').length} ห้อง | {b.rooms}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">ยืนยัน</span>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>

                                        <div className="bg-white p-6 rounded-lg shadow">
                                            <h3 className="font-bold text-lg mb-4 text-indigo-800 border-b pb-2"><i className="fas fa-chart-bar mr-2"></i>สถิติรายเดือน (จำนวนครั้ง)</h3>
                                            <div className="flex items-end justify-between h-48 gap-2 pt-6 px-2">
                                                {stats.monthlyData.map((d,i) => (
                                                    <div key={i} className="w-full flex flex-col items-center group relative h-full justify-end">
                                                        <div className="w-full bg-indigo-500 rounded-t hover:bg-indigo-600 transition-all relative flex flex-col justify-end items-center group-hover:shadow-lg" style={{height: `${d.height}%`}}>
                                                            {d.count > 0 && <div className="text-white text-[10px] font-bold mb-1 opacity-80">{d.count}</div>}
                                                        </div>
                                                        <div className="text-[10px] text-gray-500 mt-2 font-medium">{d.month}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <button onClick={()=>setShowAdminBooking(true)} className="w-full bg-white border-2 border-dashed border-gray-300 text-gray-600 p-4 rounded-xl font-bold hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition flex items-center justify-center gap-2"><i className="fas fa-plus-circle text-2xl"></i> สร้างรายการจองใหม่ (Admin)</button>
                                </div>
                            )}

                            {activeTab === 'bookings' && (
                                <div>
                                    <div className="flex flex-col md:flex-row gap-4 mb-4">
                                        <div className="flex gap-2 overflow-x-auto pb-2">{['all','pending','confirmed','upcoming'].map(f=><button key={f} onClick={()=>setFilter(f)} className={`px-3 py-1 rounded-full text-xs font-bold ${filter===f?'bg-gray-800 text-white':'bg-white text-gray-600 border'}`}>{FILTER_NAMES[f]}</button>)}</div>
                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            <input className="w-full md:w-64 pl-4 pr-4 py-2 rounded-full border" placeholder="ค้นหา..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                            {/* Report Button */}
                                            <button onClick={handlePrintReport} className="bg-gray-100 text-gray-600 px-3 py-2 rounded-full hover:bg-gray-200" title="รายงานแบบทางการ"><i className="fas fa-file-alt"></i></button>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {filteredBookings.map(b=>(
                                            <div key={b.id} className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500 relative">
                                                <div className="flex justify-between items-start mb-2"><div><div className="text-xs text-gray-400">{b.id}</div><div className="font-bold text-lg">{b.name}</div></div><StatusBadge status={b.status}/></div>
                                                <div className="text-sm text-gray-600 mb-2"><i className="fas fa-calendar mr-1"></i> {formatThaiDate(b.checkIn)} - {formatThaiDate(b.checkOut)}</div>
                                                <div className="text-sm text-gray-600 mb-1"><i className="fab fa-line mr-1 text-green-500"></i> {b.lineProfile || '-'} &nbsp; <i className="fas fa-phone mr-1"></i> {b.phone}</div>
                                                <div className="bg-gray-50 p-2 rounded text-sm mb-2 text-green-700">{b.rooms}</div>
                                                {b.food && b.food !== '-' && <div className="text-xs text-orange-600 bg-orange-50 p-1 rounded mb-2"><i className="fas fa-utensils mr-1"></i> {b.food}</div>}
                                                <div className="flex justify-end gap-2">
                                                    {String(b.slip||'').includes('http') && <button onClick={()=>setViewSlip(b.slip)} className="bg-blue-50 text-blue-600 px-3 py-1 rounded text-sm font-bold">สลิป</button>}
                                                    
                                                    {/* CONFIRM BUTTON (Moved Outside) */}
                                                    {b.status === 'รอตรวจสอบ' && (
                                                        <button onClick={()=>updateStatus(b.id, 'ยืนยัน')} className="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-green-700 shadow">ยืนยัน</button>
                                                    )}

                                                    <button onClick={()=>setViewBooking(b)} className="bg-orange-50 text-orange-600 px-3 py-1 rounded text-sm font-bold">จัดการ</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'calendar' && (
                                <div className="bg-white rounded-lg shadow p-4">
                                    <div className="flex justify-between items-center mb-4"><button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()-1)))} className="p-2 bg-gray-100 rounded">{'<'}</button><h2 className="text-xl font-bold">{calendarDate.toLocaleString('th-TH',{month:'long',year:'numeric'})}</h2><button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()+1)))} className="p-2 bg-gray-100 rounded">{'>'}</button></div>
                                    <div className="grid grid-cols-7 gap-1 text-center text-xs font-bold bg-gray-200 p-2"><div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div></div>
                                    <div className="grid grid-cols-7 gap-1 border-l border-b border-gray-200">{days.map((d,i)=><div key={i} className="border-t border-r border-gray-200 calendar-day p-1 relative">{d&&<div className="text-right text-xs text-gray-500">{d}</div>}{getBookingsForDate(d).map(b=><div key={b.id} onClick={()=>setViewBooking(b)} className={`text-[10px] p-1 rounded mb-1 truncate cursor-pointer text-white ${b.status==='ยืนยัน'?'bg-green-500':'bg-yellow-500'}`}>{b.name}</div>)}</div>)}</div>
                                </div>
                            )}

                            {activeTab === 'rooms' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-lg text-purple-800"><i className="fas fa-door-open mr-2"></i>จัดการห้องพัก & แผนที่</h3>
                                            <button onClick={() => openRoomModal()} className="bg-purple-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-purple-700 shadow"><i className="fas fa-plus mr-1"></i> เพิ่มห้อง</button>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-100 text-gray-600 font-bold"><tr><th className="p-3">ID</th><th className="p-3">ชื่อห้อง</th><th className="p-3">ประเภท</th><th className="p-3">พัก(คน)</th><th className="p-3 text-center">แผนที่ (X,Y)</th><th className="p-3 text-right">จัดการ</th></tr></thead>
                                                <tbody className="divide-y">
                                                    {Object.keys(roomConfig).map(rid => {
                                                        const room = roomConfig[rid];
                                                        const pos = mapConfig[rid] || {x: '-', y: '-'};
                                                        return (
                                                            <tr key={rid} className="hover:bg-gray-50">
                                                                <td className="p-3 font-mono font-bold text-purple-700">{rid}</td>
                                                                <td className="p-3">{room.name}</td>
                                                                <td className="p-3"><span className="bg-gray-200 px-2 py-1 rounded text-xs">{room.type}</span></td>
                                                                <td className="p-3">{room.min}-{room.maxCap}</td>
                                                                <td className="p-3 text-center text-xs text-gray-500">({pos.x}%, {pos.y}%)</td>
                                                                <td className="p-3 text-right space-x-2">
                                                                    <button onClick={()=>openRoomModal(room)} className="text-blue-500 hover:text-blue-700"><i className="fas fa-edit"></i></button>
                                                                    <button onClick={()=>handleDeleteRoom(rid)} className="text-red-500 hover:text-red-700"><i className="fas fa-trash"></i></button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {siteSettings && (
                                        <div className="p-4 bg-white rounded border border-gray-200 shadow">
                                            <h3 className="font-bold text-gray-700 mb-2">📸 รูปภาพห้องพัก (จัดการรูป)</h3>
                                            <div className="flex gap-2 mb-2">
                                                <select className="border p-2 rounded text-sm w-full max-w-xs" value={selectedRoomForImg} onChange={e=>setSelectedRoomForImg(e.target.value)}><option value="">เลือกห้องที่จะเพิ่มรูป...</option>{ROOM_IDS.map(rid => <option key={rid} value={rid}>{ROOM_NAMES[rid]}</option>)}</select>
                                                {selectedRoomForImg && <input type="file" multiple accept="image/*" className="text-sm" onChange={e => handleMultipleImageUpload(e.target.files, imgs => { const old = siteSettings.roomImages[selectedRoomForImg] || []; setSiteSettings({...siteSettings, roomImages: {...siteSettings.roomImages, [selectedRoomForImg]: [...old, ...imgs]}}); })} />}
                                            </div>
                                            {selectedRoomForImg && (siteSettings.roomImages[selectedRoomForImg] || []).length > 0 && (
                                                <div className="flex gap-2 overflow-x-auto py-2">
                                                    {(siteSettings.roomImages[selectedRoomForImg] || []).map((img, idx) => (
                                                        <div key={idx} className="relative w-24 h-24 flex-shrink-0 group">
                                                            <img src={img} className="w-full h-full object-cover rounded shadow"/>
                                                            <button onClick={()=>removeRoomImage(selectedRoomForImg, idx)} className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition"><i className="fas fa-times"></i></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            {selectedRoomForImg && (siteSettings.roomImages[selectedRoomForImg] || []).length === 0 && <p className="text-xs text-gray-400">ยังไม่มีรูปภาพสำหรับห้องนี้</p>}
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="space-y-8 animate-fade-in">
                                    {siteSettings && (
                                        <div className="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                                <h2 className="text-xl font-bold text-gray-800"><i className="fas fa-store mr-2"></i>ตั้งค่าหน้าร้าน</h2>
                                                <button onClick={handleSaveSiteSettings} disabled={savingSiteSettings} className="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 disabled:bg-gray-400"> {savingSiteSettings ? 'กำลังบันทึก...' : 'บันทึก'} </button>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div><label className="text-sm font-bold block mb-1">ชื่อร้าน</label><input className="w-full border p-2 rounded" value={siteSettings.headerTitle} onChange={e => setSiteSettings({...siteSettings, headerTitle: e.target.value})} /></div>
                                                <div><label className="text-sm font-bold block mb-1">คำอธิบาย</label><textarea className="w-full border p-2 rounded" rows="3" value={siteSettings.headerDesc} onChange={e => setSiteSettings({...siteSettings, headerDesc: e.target.value})}></textarea></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                <div className="bg-gray-50 p-2 rounded text-center"><p className="text-xs mb-1">Banner</p>{siteSettings.bannerUrl && <img src={siteSettings.bannerUrl} className="h-20 w-full object-cover rounded mb-2"/>}<input type="file" onChange={e=>handleImageUpload(e.target.files[0], b64=>setSiteSettings({...siteSettings, bannerUrl:b64}))} className="text-xs"/></div>
                                                <div className="bg-gray-50 p-2 rounded text-center"><p className="text-xs mb-1">Logo</p>{siteSettings.logoUrl && <img src={siteSettings.logoUrl} className="h-20 w-20 mx-auto object-cover rounded-full mb-2"/>}<input type="file" onChange={e=>handleImageUpload(e.target.files[0], b64=>setSiteSettings({...siteSettings, logoUrl:b64}))} className="text-xs"/></div>
                                            </div>

                                            {/* Food Menu Manager */}
                                            <div className="mb-6 p-4 bg-gray-50 rounded border">
                                                <h3 className="font-bold text-gray-700 mb-2">🍽️ เมนูอาหาร</h3>
                                                <div className="flex gap-2 items-end mb-4 flex-wrap">
                                                    <input placeholder="ชื่ออาหาร" className="border p-2 rounded text-sm w-32" value={newFood.name} onChange={e=>setNewFood({...newFood, name: e.target.value})} />
                                                    <input type="number" placeholder="ราคา" className="border p-2 rounded text-sm w-20" value={newFood.price} onChange={e=>setNewFood({...newFood, price: e.target.value})} />
                                                    <input placeholder="คำอธิบาย (ถ้ามี)" className="border p-2 rounded text-sm flex-1" value={newFood.desc} onChange={e=>setNewFood({...newFood, desc: e.target.value})} />
                                                    <div className="w-full md:w-auto mt-2 md:mt-0"><input type="file" className="text-xs" onChange={e=>handleImageUpload(e.target.files[0], b64=>setNewFood({...newFood, img: b64}))} /></div>
                                                    <button onClick={addFoodItem} className="bg-green-600 text-white px-3 py-2 rounded text-sm">เพิ่ม</button>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                    {(siteSettings.foodMenu||[]).map((f, index) => (
                                                        <div key={f.id} className="relative border rounded p-2 bg-white">
                                                            <img src={f.img} className="w-full h-20 object-cover rounded mb-1 bg-gray-200" />
                                                            <div className="font-bold text-sm truncate">{f.name}</div>
                                                            {f.desc && <div className="text-[10px] text-gray-500 truncate">{f.desc}</div>}
                                                            <div className="text-xs text-green-600">{f.price} บาท</div>
                                                            <button onClick={()=>removeFoodItem(f.id)} className="absolute top-1 right-1 text-red-500 bg-white rounded-full w-5 h-5 shadow flex items-center justify-center"><i className="fas fa-trash text-xs"></i></button>
                                                            <div className="absolute top-1 left-1 flex gap-1">
                                                                <button onClick={()=>moveFoodItem(index, 'up')} className="bg-gray-200 hover:bg-gray-300 rounded w-5 h-5 flex items-center justify-center text-xs" disabled={index===0}>↑</button>
                                                                <button onClick={()=>moveFoodItem(index, 'down')} className="bg-gray-200 hover:bg-gray-300 rounded w-5 h-5 flex items-center justify-center text-xs" disabled={index===(siteSettings.foodMenu.length-1)}>↓</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                                            <h3 className="font-bold text-lg mb-4 text-green-800">โค้ดส่วนลด</h3>
                                            <div className="flex gap-2 mb-4 items-end bg-gray-50 p-2 rounded">
                                                <div><label className="text-xs">Code</label><input className="border p-2 rounded w-24 block text-sm" value={formDiscount.code} onChange={e=>setFormDiscount({...formDiscount, code:e.target.value})} /></div>
                                                <div>
                                                    <label className="text-xs">Type</label>
                                                    <select className="border p-2 rounded block text-sm" value={formDiscount.type} onChange={e=>setFormDiscount({...formDiscount, type:e.target.value})}>
                                                        <option value="FIXED">บาท</option>
                                                        <option value="PERCENT">%</option>
                                                    </select>
                                                </div>
                                                <div><label className="text-xs">Val</label><input type="number" className="border p-2 rounded w-16 block text-sm" value={formDiscount.value} onChange={e=>setFormDiscount({...formDiscount, value:e.target.value})} /></div>
                                                <button onClick={()=>handleSaveSetting('discount', formDiscount)} className="bg-green-600 text-white px-3 py-2 rounded text-sm mb-0.5">เพิ่ม</button>
                                            </div>
                                            <ul className="divide-y max-h-40 overflow-y-auto">{settings.discounts.map((d,i)=><li key={i} className="flex justify-between p-2 text-sm"><span><b>{d.code}</b>: {d.value} {d.type === 'PERCENT' ? '%' : 'บาท'}</span><button onClick={()=>handleDeleteSetting('discount',d.id)} className="text-red-500"><i className="fas fa-trash"></i></button></li>)}</ul>
                                        </div>
                                        <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                                            <h3 className="font-bold text-lg mb-4 text-red-800">วันปิดบริการ (ทั้งหมด)</h3>
                                            <div className="flex gap-2 mb-4 items-end bg-gray-50 p-2 rounded flex-wrap">
                                                <div><label className="text-[10px] text-gray-500 block">เริ่ม</label><input type="date" className="border p-2 rounded text-sm" value={formClosed.startDate} onChange={e=>setFormClosed({...formClosed, startDate:e.target.value})} /></div>
                                                <div><label className="text-[10px] text-gray-500 block">ถึง</label><input type="date" className="border p-2 rounded text-sm" value={formClosed.endDate} onChange={e=>setFormClosed({...formClosed, endDate:e.target.value})} /></div>
                                                <div className="flex-1"><label className="text-[10px] text-gray-500 block">หมายเหตุ</label><input type="text" className="border p-2 rounded text-sm w-full" placeholder="ระบุสาเหตุ" value={formClosed.reason} onChange={e=>setFormClosed({...formClosed, reason:e.target.value})} /></div>
                                                <button onClick={()=>handleSaveSetting('closed', formClosed)} className="bg-red-600 text-white px-3 py-2 rounded text-sm mb-0.5">ปิด</button>
                                            </div>
                                            <ul className="divide-y max-h-40 overflow-y-auto">{settings.closed.map((c,i)=><li key={i} className="flex justify-between p-2 text-sm text-red-800"><span>{formatThaiDate(c.date)} {c.reason ? `(${c.reason})` : ''}</span><button onClick={()=>handleDeleteSetting('closed',c.id)} className="text-red-500"><i className="fas fa-trash"></i></button></li>)}</ul>
                                        </div>
                                        <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                                            <h3 className="font-bold text-lg mb-4 text-orange-800">ปิดเฉพาะห้อง</h3>
                                            <div className="flex gap-2 mb-4 items-end bg-gray-50 p-2 rounded flex-wrap">
                                                <div><label className="text-[10px] text-gray-500 block">เริ่ม</label><input type="date" className="border p-2 rounded text-sm" value={formRoomClosure.startDate} onChange={e=>setFormRoomClosure({...formRoomClosure, startDate:e.target.value})} /></div>
                                                <div><label className="text-[10px] text-gray-500 block">ถึง</label><input type="date" className="border p-2 rounded text-sm" value={formRoomClosure.endDate} onChange={e=>setFormRoomClosure({...formRoomClosure, endDate:e.target.value})} /></div>
                                                <div className="w-full sm:w-auto"><label className="text-[10px] text-gray-500 block">ห้อง</label><select className="border p-2 rounded text-sm w-full" value={formRoomClosure.roomId} onChange={e=>setFormRoomClosure({...formRoomClosure, roomId:e.target.value})}><option value="">เลือกห้อง</option>{ROOM_IDS.map(r=><option key={r} value={r}>{ROOM_NAMES[r] || r}</option>)}</select></div>
                                                <div className="flex-1"><label className="text-[10px] text-gray-500 block">หมายเหตุ</label><input type="text" className="border p-2 rounded text-sm w-full" placeholder="ระบุสาเหตุ" value={formRoomClosure.reason} onChange={e=>setFormRoomClosure({...formRoomClosure, reason:e.target.value})} /></div>
                                                <button onClick={()=>handleSaveSetting('room_closure', formRoomClosure)} className="bg-orange-600 text-white px-3 py-2 rounded text-sm mb-0.5">ปิดห้อง</button>
                                            </div>
                                            <ul className="divide-y max-h-40 overflow-y-auto">{settings.roomClosures.map((c,i)=><li key={i} className="flex justify-between p-2 text-sm text-orange-800"><span>{formatThaiDate(c.date)} : {ROOM_NAMES[c.roomId] || c.roomId} {c.reason ? `(${c.reason})` : ''}</span><button onClick={()=>handleDeleteSetting('room_closure',c.id)} className="text-red-500"><i className="fas fa-trash"></i></button></li>)}</ul>
                                        </div>
                                        <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                                            <h3 className="font-bold text-lg mb-4 text-blue-800">วันราคาพิเศษ (High Season)</h3>
                                            <div className="flex gap-2 mb-4 items-end bg-gray-50 p-2 rounded flex-wrap">
                                                <div><label className="text-[10px] text-gray-500 block">เริ่ม</label><input type="date" className="border p-2 rounded text-sm" value={formSpecial.startDate} onChange={e=>setFormSpecial({...formSpecial, startDate:e.target.value})} /></div>
                                                <div><label className="text-[10px] text-gray-500 block">ถึง</label><input type="date" className="border p-2 rounded text-sm" value={formSpecial.endDate} onChange={e=>setFormSpecial({...formSpecial, endDate:e.target.value})} /></div>
                                                <div className="flex-1"><label className="text-[10px] text-gray-500 block">หมายเหตุ</label><input type="text" className="border p-2 rounded text-sm w-full" placeholder="เช่น ปีใหม่" value={formSpecial.desc} onChange={e=>setFormSpecial({...formSpecial, desc:e.target.value})} /></div>
                                                <button onClick={()=>handleSaveSetting('special', formSpecial)} className="bg-blue-600 text-white px-3 py-2 rounded text-sm mb-0.5">เพิ่ม</button>
                                            </div>
                                            <ul className="divide-y max-h-40 overflow-y-auto">{settings.special.map((c,i)=><li key={i} className="flex justify-between p-2 text-sm text-blue-800"><span>{formatThaiDate(c.date)} {c.desc ? `(${c.desc})` : ''}</span><button onClick={()=>handleDeleteSetting('special',c.id)} className="text-red-500"><i className="fas fa-trash"></i></button></li>)}</ul>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* ROOM MODAL */}
                        {isRoomModalOpen && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl animate-modal overflow-hidden h-[90vh] flex flex-col">
                                    <div className="bg-purple-600 p-4 text-white font-bold flex justify-between items-center shrink-0">
                                        <h3>{editingRoom ? 'แก้ไขห้องพัก' : 'เพิ่มห้องพักใหม่'}</h3>
                                        <button onClick={()=>setIsRoomModalOpen(false)}><i className="fas fa-times"></i></button>
                                    </div>
                                    <div className="p-6 space-y-4 overflow-y-auto flex-1 custom-scrollbar">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs font-bold text-gray-500">Room ID</label><input className="w-full border p-2 rounded bg-gray-50" value={formRoom.roomId} onChange={e=>setFormRoom({...formRoom, roomId:e.target.value})} disabled={!!editingRoom} placeholder="เช่น R5" /></div>
                                            <div><label className="text-xs font-bold text-gray-500">ชื่อห้องพัก</label><input className="w-full border p-2 rounded" value={formRoom.name} onChange={e=>setFormRoom({...formRoom, name:e.target.value})} placeholder="ชื่อที่แสดง" /></div>
                                        </div>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div><label className="text-xs font-bold text-gray-500">ประเภท</label><select className="w-full border p-2 rounded text-sm" value={formRoom.type} onChange={e=>setFormRoom({...formRoom, type:e.target.value})}><option value="room">บ้านพัก</option><option value="tent">เต็นท์กระโจม</option><option value="tent_rent">เต็นท์สนาม</option><option value="ground">ลานกางเต็นท์</option></select></div>
                                            <div><label className="text-xs font-bold text-gray-500">ขั้นต่ำ (คน)</label><input type="number" className="w-full border p-2 rounded" value={formRoom.min} onChange={e=>setFormRoom({...formRoom, min:e.target.value})} /></div>
                                            <div><label className="text-xs font-bold text-gray-500">สูงสุด (คน)</label><input type="number" className="w-full border p-2 rounded" value={formRoom.max} onChange={e=>setFormRoom({...formRoom, max:e.target.value})} /></div>
                                        </div>
                                        <div><label className="text-xs font-bold text-gray-500">คำอธิบายห้องพัก</label><textarea className="w-full border p-2 rounded text-sm h-20" placeholder="รายละเอียดสิ่งอำนวยความสะดวก..." value={formRoom.desc} onChange={e=>setFormRoom({...formRoom, desc:e.target.value})}></textarea></div>
                                        <div><label className="text-xs font-bold text-gray-500">โครงสร้างราคา (JSON)</label><textarea className="w-full border p-2 rounded font-mono text-xs h-20" value={formRoom.pricing} onChange={e=>setFormRoom({...formRoom, pricing:e.target.value})}></textarea><p className="text-[10px] text-gray-400 mt-1">ตัวอย่าง: {`{"tiers":[{"max":2,"price":1500},{"max":4,"price":1800}]}`}</p></div>
                                        <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                            <label className="text-xs font-bold text-blue-700 block mb-2">ตำแหน่งบนแผนที่ (0-100%)</label>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="text-[10px] text-gray-500">แนวนอน (X)</label><input type="number" className="w-full border p-1 rounded text-sm text-center" value={formRoom.posX} onChange={e=>setFormRoom({...formRoom, posX:e.target.value})} /></div>
                                                <div><label className="text-[10px] text-gray-500">แนวตั้ง (Y)</label><input type="number" className="w-full border p-1 rounded text-sm text-center" value={formRoom.posY} onChange={e=>setFormRoom({...formRoom, posY:e.target.value})} /></div>
                                            </div>
                                            {/* FULL MAP ASPECT RATIO FIX */}
                                            <div className="mt-2 w-full relative rounded border overflow-hidden bg-gray-200" style={{ paddingTop: '100%' }}>
                                                <img src="https://img2.pic.in.th/3d539b84-44ce-4336-ad90-bd2f84b13eca.jpg" className="absolute top-0 left-0 w-full h-full object-cover opacity-50" />
                                                <div className="absolute w-4 h-4 bg-red-500 rounded-full border-2 border-white transform -translate-x-1/2 -translate-y-1/2 shadow" style={{left: `${formRoom.posX}%`, top: `${formRoom.posY}%`}}></div>
                                            </div>
                                        </div>

                                        {/* IMAGE MANAGEMENT INSIDE MODAL */}
                                        <div className="border-t pt-4">
                                            <label className="text-xs font-bold text-gray-500 mb-2 block">รูปภาพห้องพัก</label>
                                            <div className="flex gap-2 mb-2">
                                                <input type="file" multiple accept="image/*" className="text-sm w-full border p-1 rounded"
                                                    disabled={!formRoom.roomId}
                                                    onChange={e => handleMultipleImageUpload(e.target.files, imgs => {
                                                        const rid = formRoom.roomId;
                                                        const old = siteSettings.roomImages[rid] || [];
                                                        setSiteSettings({...siteSettings, roomImages: {...siteSettings.roomImages, [rid]: [...old, ...imgs]}});
                                                    })}
                                                />
                                            </div>
                                            {/* Image List */}
                                            <div className="flex gap-2 overflow-x-auto py-2 bg-gray-50 rounded p-2 border">
                                                {(!siteSettings.roomImages[formRoom.roomId] || siteSettings.roomImages[formRoom.roomId].length === 0) && <span className="text-xs text-gray-400">ไม่มีรูปภาพ</span>}
                                                {(siteSettings.roomImages[formRoom.roomId] || []).map((img, idx) => (
                                                    <div key={idx} className="relative w-20 h-20 flex-shrink-0 group">
                                                        <img src={img} className="w-full h-full object-cover rounded shadow"/>
                                                        <button onClick={()=>removeRoomImage(formRoom.roomId, idx)} className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition"><i className="fas fa-times"></i></button>
                                                    </div>
                                                ))}
                                            </div>
                                            <p className="text-[10px] text-red-400 mt-1">* รูปภาพจะถูกบันทึกเมื่อกดปุ่ม "บันทึก" ด้านล่าง</p>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-gray-50 flex justify-end gap-2 shrink-0 border-t">
                                        <button onClick={()=>setIsRoomModalOpen(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">ยกเลิก</button>
                                        <button onClick={handleSaveRoom} className="px-4 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 shadow">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modals for Alert/Confirm */}
                        {modal.isOpen && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center animate-modal">
                                    <h3 className="text-lg font-bold mb-2">{modal.title}</h3>
                                    <p className="text-gray-600 mb-6">{modal.message}</p>
                                    <div className="flex gap-2 justify-center">
                                        {modal.type === 'confirm' && <button onClick={closeModal} className="px-4 py-2 border rounded hover:bg-gray-50">ยกเลิก</button>}
                                        <button onClick={modal.type==='confirm'?modal.onConfirm:closeModal} className="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">ตกลง</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- LOADING OVERLAY (New) --- */}
                        {loading && (
                            <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
                                <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-2xl flex flex-col items-center animate-modal max-w-sm w-full mx-4 border border-gray-100 relative overflow-hidden">
                                    <div className="relative w-20 h-20 mb-6">
                                        <div className="absolute top-0 left-0 w-full h-full border-4 border-gray-100 dark:border-gray-700 rounded-full"></div>
                                        <div className="absolute top-0 left-0 w-full h-full border-4 border-green-500 rounded-full border-t-transparent animate-spin"></div>
                                        <div className="absolute inset-0 flex items-center justify-center">
                                            <i className="fas fa-campground text-2xl text-green-600 animate-bounce"></i>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">กำลังทำงาน...</h3>
                                    <p className="text-gray-500 dark:text-gray-400 text-sm text-center">ระบบกำลังประมวลผลข้อมูล<br/>กรุณารอสักครู่ครับ</p>
                                </div>
                            </div>
                        )}
                        
                        {/* View Booking & Slip Modals (Fully Restored) */}
                        {viewSlip && <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={()=>setViewSlip(null)}><img src={viewSlip} className="max-h-full rounded shadow-lg"/></div>}
                        
                        {viewBooking && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={()=>setViewBooking(null)}>
                                <div className="bg-white rounded-xl w-full max-w-md p-6 animate-modal overflow-y-auto max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                                    <h3 className="text-xl font-bold mb-4">{viewBooking.name}</h3>
                                    <div className="space-y-2 text-sm text-gray-600 mb-6">
                                        <p>Check-in: <b>{formatThaiDate(viewBooking.checkIn)}</b></p>
                                        <p>Check-out: <b>{formatThaiDate(viewBooking.checkOut)}</b></p>
                                        <p>LINE Name: <b className="text-green-600">{viewBooking.lineProfile || '-'}</b></p>
                                        <p>เบอร์โทร: <b>{viewBooking.phone}</b></p>
                                        <p>Rooms: {viewBooking.rooms}</p>
                                        <p>Food: {viewBooking.food}</p>
                                        <div className="flex justify-between bg-gray-100 p-2 rounded"><span>ยอดสุทธิ</span><b>{parseInt(viewBooking.price).toLocaleString()}</b></div>
                                        <div className="flex justify-between bg-red-50 p-2 rounded text-red-600"><span>มัดจำ</span><b>{parseInt(viewBooking.deposit).toLocaleString()}</b></div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        {/* Status & Print */}
                                        <div className="flex gap-2">
                                            <button onClick={()=>handlePrintReceipt()} className="flex-1 py-2 border rounded hover:bg-gray-50 text-sm"><i className="fas fa-print mr-1"></i>ใบเสร็จ</button>
                                            {/* Confirm button removed from Modal as per user request */}
                                            {viewBooking.status==='รอตรวจสอบ' && <div className="flex flex-1 gap-1"><button onClick={()=>updateStatus(viewBooking.id,'ยกเลิก')} className="flex-1 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">ยกเลิก</button></div>}
                                            {/* Cancel Button for Confirmed Booking */}
                                            {viewBooking.status==='ยืนยัน' && <button onClick={()=>updateStatus(viewBooking.id,'ยกเลิก')} className="flex-1 py-2 bg-red-100 text-red-600 border border-red-200 rounded text-sm hover:bg-red-200">ยกเลิกการจอง</button>}
                                        </div>

                                        {/* Reschedule Section */}
                                        <div className="border-t pt-3">
                                            <h4 className="font-bold text-sm mb-2 text-orange-700">📅 เลื่อนวันเข้าพัก</h4>
                                            <div className="flex gap-2 mb-2">
                                                <input type="date" className="w-1/2 text-xs border p-1 rounded" value={rescheduleData.checkIn} onChange={e=>setRescheduleData({...rescheduleData, checkIn: e.target.value})} />
                                                <input type="date" className="w-1/2 text-xs border p-1 rounded" value={rescheduleData.checkOut} onChange={e=>setRescheduleData({...rescheduleData, checkOut: e.target.value})} />
                                            </div>
                                            <button onClick={handleReschedule} className="w-full bg-orange-100 text-orange-700 text-xs py-2 rounded hover:bg-orange-200">บันทึกการเลื่อนวัน</button>
                                        </div>

                                        {/* Add Food Section */}
                                        <div className="border-t pt-3">
                                            <h4 className="font-bold text-sm mb-2 text-green-700">🍽️ เพิ่มรายการอาหาร</h4>
                                            <div className="flex gap-2 mb-2">
                                                <select className="flex-1 text-xs border p-1 rounded" value={selectedAddFood} onChange={e=>setSelectedAddFood(e.target.value)}>
                                                    <option value="">เลือกเมนู...</option>
                                                    {siteSettings?.foodMenu?.map(f=><option key={f.id} value={f.id}>{f.name} ({f.price}.-)</option>)}
                                                </select>
                                                <input type="number" className="w-16 text-xs border p-1 rounded text-center" value={addFoodQty} onChange={e=>setAddFoodQty(e.target.value)} min="1" />
                                            </div>
                                            <button onClick={handleAddFood} className="w-full bg-green-100 text-green-700 text-xs py-2 rounded hover:bg-green-200">เพิ่มรายการ</button>
                                        </div>

                                        {/* Add Custom Item / Extra Charge Section */}
                                        <div className="border-t pt-3 mt-2">
                                            <h4 className="font-bold text-sm mb-2 text-purple-700">📝 เพิ่มรายการอื่นๆ / ปรับยอด</h4>
                                            <div className="flex gap-2 mb-2">
                                                <input placeholder="รายการ (เช่น ค่าน้ำแข็ง)" className="flex-1 text-xs border p-1 rounded" value={customItem.name} onChange={e=>setCustomItem({...customItem, name: e.target.value})} />
                                                <input type="number" placeholder="ราคา" className="w-16 text-xs border p-1 rounded text-center" value={customItem.price} onChange={e=>setCustomItem({...customItem, price: e.target.value})} />
                                                <input type="number" placeholder="จำนวน" className="w-12 text-xs border p-1 rounded text-center" value={customItem.qty} onChange={e=>setCustomItem({...customItem, qty: e.target.value})} />
                                            </div>
                                            <button onClick={handleAddCustomItem} className="w-full bg-purple-100 text-purple-700 text-xs py-2 rounded hover:bg-purple-200">บันทึกยอดเพิ่ม</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {showAdminBooking && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity modal-overlay">
                                <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-modal max-h-[90vh] flex flex-col">
                                    <div className="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                                        <h3 className="font-bold text-lg"><i className="fas fa-plus-circle mr-2"></i> สร้างรายการจองใหม่</h3>
                                        <button onClick={() => setShowAdminBooking(false)} className="hover:text-gray-200"><i className="fas fa-times text-xl"></i></button>
                                    </div>
                                    <div className="p-6 overflow-y-auto custom-scrollbar">
                                        <div className="space-y-4">
                                            <div><label className="block text-sm font-bold text-gray-700 mb-1">ชื่อลูกค้า</label><input className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.name} onChange={e => setAdminBookingForm({...adminBookingForm, name: e.target.value})} /></div>
                                            <div><label className="block text-sm font-bold text-gray-700 mb-1">เบอร์โทร</label><input type="tel" className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.phone} onChange={e => setAdminBookingForm({...adminBookingForm, phone: e.target.value})} /></div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="block text-sm font-bold text-gray-700 mb-1">เช็คอิน</label><input type="date" className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.checkIn} onChange={e => setAdminBookingForm({...adminBookingForm, checkIn: e.target.value})} /></div>
                                                <div><label className="block text-sm font-bold text-gray-700 mb-1">เช็คเอาท์</label><input type="date" className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.checkOut} onChange={e => setAdminBookingForm({...adminBookingForm, checkOut: e.target.value})} /></div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">เลือกห้องพัก {loadingAvailability && <span className="text-xs text-blue-500 font-normal">(กำลังตรวจสอบ...)</span>}</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {ROOM_IDS.map(r => {
                                                        const isAvailable = adminAvailability && (r === 'Z8' ? adminAvailability.zone8Available > 0 : !adminAvailability.bookedRooms.includes(r));
                                                        if (adminBookingForm.checkIn && adminBookingForm.checkOut && !isAvailable) return null;
                                                        return (
                                                            <button key={r} disabled={!adminBookingForm.checkIn || !adminBookingForm.checkOut} onClick={() => { const currentRooms = adminBookingForm.rooms.includes(r) ? adminBookingForm.rooms.filter(room => room !== r) : [...adminBookingForm.rooms, r]; setAdminBookingForm({...adminBookingForm, rooms: currentRooms}); }} className={`py-2 px-3 rounded-lg text-sm font-bold transition border truncate ${adminBookingForm.rooms.includes(r) ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 'bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100'} ${(!adminBookingForm.checkIn || !adminBookingForm.checkOut) ? 'opacity-50 cursor-not-allowed' : ''}`}>{ROOM_NAMES[r] || r}</button>
                                                        );
                                                    })}
                                                    {adminBookingForm.checkIn && adminBookingForm.checkOut && adminAvailability && adminAvailability.bookedRooms.length === ROOM_IDS.length - (adminAvailability.zone8Available > 0 ? 0 : 1) && <div className="col-span-2 text-center text-red-500 text-xs py-2">ไม่มีห้องว่างในช่วงเวลานี้</div>}
                                                    {(!adminBookingForm.checkIn || !adminBookingForm.checkOut) && <div className="col-span-2 text-center text-gray-400 text-xs py-2">กรุณาเลือกวันเข้าพักก่อน</div>}
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3 pt-2 border-t">
                                                <div><label className="block text-sm font-bold text-gray-700 mb-1">ยอดรวมสุทธิ</label><input type="number" className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.price} onChange={e => setAdminBookingForm({...adminBookingForm, price: e.target.value})} /></div>
                                                <div><label className="block text-sm font-bold text-gray-700 mb-1">มัดจำที่รับมา</label><input type="number" className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={adminBookingForm.deposit} onChange={e => setAdminBookingForm({...adminBookingForm, deposit: e.target.value})} /></div>
                                            </div>
                                            <div className="pt-4"><button onClick={handleCreateAdminBooking} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg hover:bg-green-700 transition transform active:scale-95">บันทึกรายการจอง</button></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {/* Print Templates (Hidden) */}
                    <div id="print-container">
                        {printMode === 'receipt' && viewBooking && (
                            <div id="receipt-print-area">
                                <div>
                                    <div className="flex justify-between items-start mb-6 border-b-2 border-gray-800 pb-4">
                                        <div className="flex gap-4 items-center">
                                            {siteSettings && siteSettings.logoUrl && <img src={siteSettings.logoUrl} className="w-20 h-20 object-cover rounded-full" />}
                                            <div>
                                                <h1 className="text-2xl font-bold text-green-900">{siteSettings?.headerTitle}</h1>
                                                <p className="text-sm text-gray-600">หมู่ที่ 3 ต.ฉลุง อ.หาดใหญ่ จ.สงขลา 90110</p>
                                                <p className="text-sm font-bold mt-2">โทร: 061-592-4262</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <h2 className="text-3xl font-bold text-gray-800 uppercase tracking-widest">RECEIPT</h2>
                                            <p className="text-sm text-gray-500">ใบเสร็จรับเงิน</p>
                                            <div className="mt-4 text-sm">
                                                <p><b>เลขที่:</b> {viewBooking.id}</p>
                                                <p><b>วันที่:</b> {new Date().toLocaleDateString('th-TH')}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-between mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                                        <div className="w-1/2 pr-4 border-r border-gray-200">
                                            <h3 className="font-bold text-gray-700 mb-2 border-b pb-1">ลูกค้า</h3>
                                            <p className="text-sm mb-1"><b>ชื่อ:</b> {viewBooking.name}</p>
                                            <p className="text-sm mb-1"><b>เบอร์โทร:</b> {viewBooking.phone}</p>
                                        </div>
                                        <div className="w-1/2 pl-4 text-right">
                                            <h3 className="font-bold text-gray-700 mb-2 border-b pb-1">รายละเอียด</h3>
                                            <p className="text-sm mb-1"><b>เข้าพัก:</b> {formatThaiDate(viewBooking.checkIn)}</p>
                                            <p className="text-sm mb-1"><b>ออก:</b> {formatThaiDate(viewBooking.checkOut)}</p>
                                        </div>
                                    </div>
                                    <table className="w-full mb-4 border-collapse">
                                        <thead><tr className="bg-gray-800 text-white text-sm"><th className="py-2 px-3 text-left">รายการ</th><th className="py-2 px-3 text-right">จำนวนเงิน</th></tr></thead>
                                        <tbody>
                                            <tr className="border-b"><td className="py-2 px-3">{viewBooking.rooms} {viewBooking.food && viewBooking.food !== '-' ? `+ ${viewBooking.food}` : ''}</td><td className="py-2 px-3 text-right">{parseInt(viewBooking.price).toLocaleString()}</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr><td className="pt-2 text-right font-bold">รวมทั้งสิ้น</td><td className="pt-2 text-right font-bold">{parseInt(viewBooking.price).toLocaleString()}</td></tr>
                                            <tr><td className="pt-1 text-right text-red-500">หักมัดจำ</td><td className="pt-1 text-right text-red-500">-{parseInt(viewBooking.deposit).toLocaleString()}</td></tr>
                                            <tr className="bg-gray-100"><td className="py-2 text-right font-bold">ยอดคงเหลือ</td><td className="py-2 text-right font-bold text-green-700">{(parseInt(viewBooking.price)-parseInt(viewBooking.deposit)).toLocaleString()}</td></tr>
                                        </tfoot>
                                    </table>
                                    
                                    <div className="mt-16 flex justify-between items-end px-8">
                                        <div className="text-center">
                                            <div className="border-b border-black w-40 mb-2"></div>
                                            <p className="text-sm font-bold">ผู้รับเงิน (Payee)</p>
                                            <p className="text-xs text-gray-500">วันที่: ...../...../.......</p>
                                        </div>
                                        <div className="text-center">
                                            <div className="border-b border-black w-40 mb-2"></div>
                                            <p className="text-sm font-bold">ผู้จ่ายเงิน (Payer)</p>
                                            <p className="text-xs text-gray-500">วันที่: ...../...../.......</p>
                                        </div>
                                    </div>
                                    
                                    {/* Footer */}
                                    <div className="text-center text-[10px] text-gray-400 mt-4">
                                        <p>ขอบคุณที่ใช้บริการ ขนำลุงดำ แคมป์ปิ้ง | System Generated</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {printMode === 'report' && (
                            <div id="report-print-area">
                                <div className="mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h1 className="text-xl font-bold">{siteSettings?.headerTitle}</h1>
                                            <h2 className="text-lg">รายงานการจองห้องพัก (Booking Report)</h2>
                                        </div>
                                        <div className="text-right text-xs text-gray-500">
                                            <p>พิมพ์วันที่: {new Date().toLocaleDateString('th-TH')}</p>
                                            <p>สถานะ: {FILTER_NAMES[filter]}</p>
                                        </div>
                                    </div>
                                    <table className="w-full text-xs border-collapse border border-gray-300">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="border border-gray-300 p-2 w-10">#</th>
                                                <th className="border border-gray-300 p-2">Booking ID</th>
                                                <th className="border border-gray-300 p-2">ลูกค้า</th>
                                                <th className="border border-gray-300 p-2">เบอร์โทร</th>
                                                <th className="border border-gray-300 p-2">เข้าพัก</th>
                                                <th className="border border-gray-300 p-2">ออก</th>
                                                <th className="border border-gray-300 p-2">ห้องพัก</th>
                                                <th className="border border-gray-300 p-2">อาหาร/อื่นๆ</th>
                                                <th className="border border-gray-300 p-2 text-right">ยอดรวม</th>
                                                <th className="border border-gray-300 p-2 text-right">มัดจำ</th>
                                                <th className="border border-gray-300 p-2 text-right">คงเหลือ</th>
                                                <th className="border border-gray-300 p-2 text-center">สถานะ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredBookings.map((b, i) => (
                                                <tr key={b.id}>
                                                    <td className="border border-gray-300 p-1 text-center">{i+1}</td>
                                                    <td className="border border-gray-300 p-1 font-mono">{b.id}</td>
                                                    <td className="border border-gray-300 p-1">{b.name}</td>
                                                    <td className="border border-gray-300 p-1">{b.phone}</td>
                                                    <td className="border border-gray-300 p-1 text-center">{formatThaiDate(b.checkIn)}</td>
                                                    <td className="border border-gray-300 p-1 text-center">{formatThaiDate(b.checkOut)}</td>
                                                    <td className="border border-gray-300 p-1">{b.rooms}</td>
                                                    <td className="border border-gray-300 p-1">{b.food}</td>
                                                    <td className="border border-gray-300 p-1 text-right">{parseInt(b.price).toLocaleString()}</td>
                                                    <td className="border border-gray-300 p-1 text-right">{parseInt(b.deposit).toLocaleString()}</td>
                                                    <td className="border border-gray-300 p-1 text-right font-bold">{(parseInt(b.price)-parseInt(b.deposit)).toLocaleString()}</td>
                                                    <td className="border border-gray-300 p-1 text-center">{b.status}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            <tr className="bg-gray-50 font-bold">
                                                <td colSpan="8" className="border border-gray-300 p-2 text-right">รวมทั้งหมด</td>
                                                <td className="border border-gray-300 p-2 text-right">{filteredBookings.reduce((s,b)=>s+parseInt(b.price),0).toLocaleString()}</td>
                                                <td className="border border-gray-300 p-2 text-right">{filteredBookings.reduce((s,b)=>s+parseInt(b.deposit),0).toLocaleString()}</td>
                                                <td className="border border-gray-300 p-2 text-right">{filteredBookings.reduce((s,b)=>s+(parseInt(b.price)-parseInt(b.deposit)),0).toLocaleString()}</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
